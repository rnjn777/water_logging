<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Urban Flood Risk Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<style>
  .low {
  background: #fde68a;
}

.medium {
  background: #f97316;
}

.high {
  background: #dc2626;
}

* { 
  box-sizing: border-box; 
  margin: 0;
  padding: 0;
}


body {
  font-family: 'Inter', sans-serif;
  height: 100vh;
  display: flex;
  flex-direction: column;
  background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
  overflow: hidden;
}

/* ANIMATED BACKGROUND PATTERN */
body::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: 
    radial-gradient(circle at 20% 50%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
    radial-gradient(circle at 80% 80%, rgba(16, 185, 129, 0.1) 0%, transparent 50%),
    radial-gradient(circle at 40% 20%, rgba(139, 92, 246, 0.1) 0%, transparent 50%);
  animation: drift 20s ease-in-out infinite;
  pointer-events: none;
}

@keyframes drift {
  0%, 100% { transform: translate(0, 0); }
  50% { transform: translate(30px, 30px); }
}

/* HEADER */
header {
  background: rgba(15, 23, 42, 0.95);
  backdrop-filter: blur(20px);
  color: white;
  padding: 20px 32px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
  position: relative;
  z-index: 10;
  border-bottom: 1px solid rgba(59, 130, 246, 0.2);
}

header::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  height: 2px;
  background: linear-gradient(90deg, 
    transparent,
    #3b82f6 20%,
    #06b6d4 40%,
    #10b981 60%,
    #8b5cf6 80%,
    transparent
  );
  animation: shimmer 3s linear infinite;
}

@keyframes shimmer {
  0% { transform: translateX(-100%); }
  100% { transform: translateX(100%); }
}

.header-content {
  display: flex;
  align-items: center;
  gap: 16px;
}

.logo-icon {
  font-size: 32px;
  animation: pulse 2s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.1); }
}

header h1 {
  font-size: 26px;
  font-weight: 800;
  background: linear-gradient(135deg, #ffffff, #60a5fa);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  letter-spacing: -0.5px;
}

.header-subtitle {
  font-size: 12px;
  color: #94a3b8;
  font-weight: 500;
  margin-top: 2px;
}

.critical-btn {
  background: linear-gradient(135deg, #dc2626, #ef4444);
  border: none;
  color: white;
  padding: 12px 24px;
  border-radius: 12px;
  font-weight: 700;
  cursor: pointer;
  box-shadow: 0 4px 20px rgba(220, 38, 38, 0.4);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  font-size: 14px;
  position: relative;
  overflow: hidden;
}

.critical-btn::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 0;
  height: 0;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.2);
  transform: translate(-50%, -50%);
  transition: width 0.6s, height 0.6s;
}

.critical-btn:hover::before {
  width: 300px;
  height: 300px;
}

.critical-btn:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 30px rgba(220, 38, 38, 0.6);
}

.critical-btn:active {
  transform: translateY(-1px);
}

.header-actions {
  display: flex;
  gap: 12px;
}

.home-btn {
  background: linear-gradient(135deg, #22c55e, #16a34a);
  color: white;
  border: none;
  padding: 10px 16px;
  border-radius: 10px;
  font-weight: 700;
  cursor: pointer;
  font-size: 14px;
  box-shadow: 0 4px 12px rgba(34, 197, 94, 0.35);
  transition: all 0.2s ease;
}

.home-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 18px rgba(34, 197, 94, 0.55);
}

/* CONTROLS BAR */
.controls {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(10px);
  padding: 16px 32px;
  display: flex;
  gap: 24px;
  align-items: center;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
  position: relative;
  z-index: 5;
  border-bottom: 1px solid rgba(226, 232, 240, 0.8);
}

.control-group {
  display: flex;
  align-items: center;
  gap: 12px;
}

.controls label {
  font-weight: 600;
  color: #1e293b;
  font-size: 14px;
  display: flex;
  align-items: center;
  gap: 8px;
}

select {
  padding: 10px 16px;
  border-radius: 10px;
  border: 2px solid #e2e8f0;
  font-weight: 600;
  font-size: 14px;
  transition: all 0.3s ease;
  background: white;
  cursor: pointer;
  color: #334155;
  min-width: 160px;
}

select:hover {
  border-color: #3b82f6;
  box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
}

select:focus {
  outline: none;
  border-color: #3b82f6;
  box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
}

.report-btn {
  background: linear-gradient(135deg, #3b82f6, #2563eb);
  color: white;
  border: none;
  padding: 11px 20px;
  border-radius: 10px;
  font-weight: 700;
  cursor: pointer;
  box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
  transition: all 0.3s ease;
  font-size: 14px;
}

.report-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
  background: linear-gradient(135deg, #2563eb, #1d4ed8);
}

/* MAP CONTAINER */
.map-wrapper {
  flex: 1;
  position: relative;
  margin: 16px;
  border-radius: 16px;
  overflow: hidden;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
  border: 1px solid rgba(255, 255, 255, 0.1);
}

#map {
  width: 100%;
  height: 100%;
}

/* LEGEND */
#legend {
  position: absolute;
  bottom: 30px;
  right: 30px;
  background: rgba(255, 255, 255, 0.98);
  backdrop-filter: blur(20px);
  padding: 14px 18px;
  border-radius: 12px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
  font-size: 13px;
  z-index: 1000;
  border: 1px solid rgba(255, 255, 255, 0.8);
  min-width: 150px;
}

.legend-title {
  font-weight: 700;
  color: #1e293b;
  margin-bottom: 10px;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.8px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.legend-item {
  display: flex;
  align-items: center;
  margin: 8px 0;
  font-weight: 600;
  color: #475569;
  transition: all 0.2s ease;
  padding: 3px;
  border-radius: 6px;
  font-size: 13px;
}

.legend-item:hover {
  background: rgba(59, 130, 246, 0.05);
  transform: translateX(4px);
}

.box {
  width: 16px;
  height: 16px;
  margin-right: 10px;
  border-radius: 5px;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
  transition: transform 0.2s ease;
}

.legend-item:hover .box {
  transform: scale(1.15);
}

/* STATS BAR */
.stats-bar {
  position: absolute;
  top: 20px;
  left: 20px;
  display: flex;
  gap: 10px;
  z-index: 1000;
}

.stat-card {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(10px);
  padding: 10px 14px;
  border-radius: 10px;
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
  border: 1px solid rgba(255, 255, 255, 0.8);
  min-width: 100px;
}

.stat-label {
  font-size: 10px;
  color: #64748b;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 3px;
}

.stat-value {
  font-size: 20px;
  font-weight: 800;
  color: #1e293b;
}

.stat-high { color: #dc2626; }
.stat-medium { color: #f97316; }
.stat-low { color: #10b981; }

/* MODAL */
#modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(15, 23, 42, 0.75);
  backdrop-filter: blur(12px);
  z-index: 2000;
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

#modalContent {
  background: linear-gradient(135deg, #ffffff, #f8fafc);
  width: 500px;
  max-height: 75vh;
  overflow: hidden;
  margin: 8vh auto;
  border-radius: 20px;
  box-shadow: 0 25px 80px rgba(0, 0, 0, 0.4);
  animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  border: 1px solid rgba(255, 255, 255, 0.8);
}

/* REPORT MODAL */
#reportModal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(15, 23, 42, 0.75);
  backdrop-filter: blur(12px);
  z-index: 2000;
  animation: fadeIn 0.3s ease;
}

#reportModalContent {
  background: linear-gradient(135deg, #ffffff, #f8fafc);
  width: 550px;
  max-width: 90%;
  max-height: 85vh;
  overflow: hidden;
  margin: 5vh auto;
  border-radius: 20px;
  box-shadow: 0 25px 80px rgba(0, 0, 0, 0.4);
  animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  border: 1px solid rgba(255, 255, 255, 0.8);
}

/* The rest of the styles and scripts are identical to map.html; we keep the reporting logic
   in the JS but remove the UI buttons so guests cannot submit reports from this page. */

</style>
</head>
<body>

<header>
  <div class="header-content">
    <div class="logo-icon">üåß</div>
    <div>
      <h1>Urban Flood Risk Dashboard</h1>
      <div class="header-subtitle">Real-time flood monitoring & analysis system</div>
    </div>
  </div>

  <div class="header-actions">
    <button class="home-btn" onclick="goHome()">üè† Home</button>
    <button class="critical-btn" onclick="openModal()">‚ö†Ô∏è Critical Areas</button>
  </div>
</header>


<div class="controls">
  <div class="control-group">
    <label>üå¶Ô∏è Rain Intensity:</label>
    <select onchange="setRain(this.value)">
      <option value="Light">üå§ Light Rain</option>
      <option value="Moderate">üåß Moderate Rain</option>
      <option value="Heavy">‚õà Heavy Rain</option>
    </select>
  </div>

  <div class="control-group">
    <label>üìä Report Severity:</label>
    <select id="severitySelect">
      <option value="Low">‚ö†Ô∏è Low</option>
      <option value="Medium">üü† Medium</option>
      <option value="High">üî¥ High</option>
    </select>
  </div>

  <!-- Report buttons intentionally removed for Guest Mode -->
</div>

<div class="map-wrapper">
  <div id="map"></div>
  
  <!-- Stats Bar -->
  <div class="stats-bar">
    <div class="stat-card">
      <div class="stat-label">High Risk</div>
      <div class="stat-value stat-high" id="highCount">0</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Medium Risk</div>
      <div class="stat-value stat-medium" id="mediumCount">0</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Low Risk</div>
      <div class="stat-value stat-low" id="lowCount">0</div>
    </div>
  </div>
  
  <!-- Legend -->
  <div id="legend">
    <div class="legend-title">üìä Risk Levels</div>
    <div class="legend-item"><span class="box low"></span> Low Risk</div>
    <div class="legend-item"><span class="box medium"></span> Medium Risk</div>
    <div class="legend-item"><span class="box high"></span> High Risk</div>
  </div>
</div>

<!-- MODAL -->
<div id="modal" onclick="closeModal(event)">
  <div id="modalContent" onclick="event.stopPropagation()">
    <div class="modal-header">
      <h3>üö® Critical Flood Zones</h3>
      <div class="modal-subtitle">Locations requiring immediate attention</div>
    </div>
    <div id="locationList"></div>
  </div>
</div>

<!-- REPORT MODAL (hidden; reporting UI not reachable in Guest Mode) -->
<div id="reportModal" onclick="closeReportModal(event)">
  <div id="reportModalContent" onclick="event.stopPropagation()">
    <div class="report-modal-header">
      <h3>üìç Report Waterlogging</h3>
      <button class="modal-close-btn" onclick="closeReportModal()">‚úï</button>
    </div>
    <div class="report-form">
      <div class="location-info">
        <div class="location-info-title">üìç Selected Location</div>
        <div class="location-coords" id="reportLocationCoords">Lat: 0.0000, Lng: 0.0000</div>
      </div>

      <div class="form-group">
        <label class="form-label">Location Name<span class="required">*</span></label>
        <input 
          type="text" 
          class="form-input" 
          id="reportLocationName"
          placeholder="Enter location name or nearby landmark..."
          required
        />
      </div>

      <div class="form-group">
        <label class="form-label">Description (Optional)</label>
        <textarea 
          class="form-textarea" 
          id="reportDescription"
          placeholder="Describe the waterlogging situation, depth, affected area, etc..."
        ></textarea>
      </div>

      <div class="form-group">
        <label class="form-label">Photo Proof (Optional)</label>
        <div class="photo-upload-area" id="photoUploadArea" onclick="document.getElementById('photoInput').click()">
          <div id="uploadPrompt">
            <div class="upload-icon">üì∑</div>
            <div class="upload-text">Click to upload photo</div>
            <div class="upload-hint">Maximum file size: 5MB | Supported: JPG, PNG</div>
          </div>
          <div id="imagePreview" style="display: none;">
            <img id="previewImg" class="preview-image" src="" alt="Preview">
            <button type="button" class="remove-image-btn" onclick="removeImage(event)">üóëÔ∏è Remove Photo</button>
          </div>
        </div>
        <input 
          type="file" 
          id="photoInput" 
          accept="image/*"
          style="display: none;"
          onchange="handleImageUpload(event)"
        />
      </div>

      <div class="form-actions">
        <button type="button" class="btn-cancel" onclick="closeReportModal()">Cancel</button>
        <button type="button" class="btn-submit" id="submitReportBtn" onclick="submitReport()">Submit Report</button>
      </div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

<script>
  const API_BASE_URL = "https://water-logging.onrender.com";
let rainLevel = "Light";
let geojsonLayer;
let reportMode = false;
let markerLayer = L.layerGroup();
let heatLayerGroup = L.layerGroup();
let geojsonLayerGroup = L.layerGroup();
let heatLayer = null;


let priorityLocations = [];
let stats = { high: 0, medium: 0, low: 0 };
let currentReportLocation = null;
let currentReportImage = null;
let currentReportLatLng = null;
let currentReportImageBase64 = null;
const REPORT_EXPIRY_MINUTES = 60;
let reportMarkers = [];
function minutesSince(ts) {
  return (Date.now() - ts) / (1000 * 60);
}
function addPulsatingReportMarker(report) {
  const icon = L.divIcon({
    className: '',
    html: `<div class="pulse-marker"></div>`,
    iconSize: [16, 16]
  });

  const marker = L.marker([report.lat, report.lng], { icon }).addTo(map);

  reportMarkers.push({
    marker,
    createdAt: report.createdAt
  });

  setTimeout(() => {
    const el = marker.getElement();
    if (!el) return;

    if (minutesSince(report.createdAt) >= REPORT_EXPIRY_MINUTES) {
      el.classList.add('fade-out');
      setTimeout(() => map.removeLayer(marker), 2000);
    }
  }, 100);
}

const delhiBounds = L.latLngBounds(
  [28.40, 76.80],
  [28.95, 77.40]
);

function getDistanceInMeters(lat1, lng1, lat2, lng2) {
  const R = 6371000; // Earth radius in meters
  const toRad = deg => deg * Math.PI / 180;

  const dLat = toRad(lat2 - lat1);
  const dLng = toRad(lng2 - lng1);

  const a =
    Math.sin(dLat / 2) * Math.sin(dLat / 2) +
    Math.cos(toRad(lat1)) *
    Math.cos(toRad(lat2)) *
    Math.sin(dLng / 2) * Math.sin(dLng / 2);

  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return R * c;
}
function hasNearbyReport(lat, lng, radiusMeters = 100) {
  const reports = [];

  const pending = JSON.parse(localStorage.getItem('waterloggingReports') || '[]');
  pending.forEach(r => {
    if (r.lat != null && r.lng != null) {
      const d = getDistanceInMeters(lat, lng, r.lat, r.lng);
      if (d <= radiusMeters) {
        reports.push({
          distance: Math.round(d),
          location: r.location || 'User Report',
          status: 'pending',
          severity: r.severity || 'unknown'
        });
      }
    }
  });

  const approved = JSON.parse(localStorage.getItem('approvedLocations') || '[]');
  approved.forEach(r => {
    if (r.lat != null && r.lng != null) {
      const d = getDistanceInMeters(lat, lng, r.lat, r.lng);
      if (d <= radiusMeters) {
        reports.push({
          distance: Math.round(d),
          location: r.location || 'Verified Report',
          status: 'approved',
          severity: r.severity || 'unknown'
        });
      }
    }
  });

  if (geojsonLayer) {
    geojsonLayer.eachLayer(layer => {
      const ll = layer.getLatLng();
      const d = getDistanceInMeters(lat, lng, ll.lat, ll.lng);

      if (d <= radiusMeters) {
        const p = layer.feature.properties;
        reports.push({
          distance: Math.round(d),
          location: p.Location_Road || 'Official Waterlogging Area',
          status: 'official',
          severity: p.Risk ? p.Risk.toLowerCase() : 'unknown'
        });
      }
    });
  }

  if (reports.length > 0) {
    reports.sort((a, b) => a.distance - b.distance);
    return { found: true, reports };
  }

  return { found: false, reports: [] };
}


const map = L.map("map", {
  maxBounds: delhiBounds,
  maxBoundsViscosity: 1.0,
  minZoom: 10,
  maxZoom: 17,
  zoomControl: false
}).setView([28.6139, 77.2090], 11);

L.control.zoom({ position: 'topright' }).addTo(map);

L.tileLayer(
  "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",
  { 
    attribution: "¬© OpenStreetMap ¬© CARTO",
    maxZoom: 19
  }
).addTo(map);

function getColor(risk) {
  if (rainLevel === "Heavy") return "#dc2626";
  if (rainLevel === "Moderate") {
    if (risk !== "Low") return "#dc2626";
    return "#f97316";
  }
  if (risk === "High") return "#dc2626";
  if (risk === "Medium") return "#f97316";
  return "#fde68a";
}

function getRadius() {
  return rainLevel === "Heavy" ? 10 :
         rainLevel === "Moderate" ? 9 : 8;
}

function enableReportMode() {
  map.getContainer().style.cursor = 'crosshair';

  map.once('click', function (e) {
    map.getContainer().style.cursor = '';

    const check = hasNearbyReport(e.latlng.lat, e.latlng.lng, 100);

    if (check.found) {
      showDuplicateWarning(check.reports);
      return;
    }

    openReportModal(e.latlng.lat, e.latlng.lng, false);
  });
}


function reportCurrentLocation() {
  if (!navigator.geolocation) return;

  navigator.geolocation.getCurrentPosition(pos => {
    const lat = pos.coords.latitude;
    const lng = pos.coords.longitude;

    map.setView([lat, lng], 16);

    const check = hasNearbyReport(lat, lng, 100);
    if (check.found) {
      showDuplicateWarning(check.reports);
      return;
    }

    openReportModal(lat, lng, true);
  });
}

function openReportModal(lat, lng, isGPS) {
  currentReportLatLng = { lat, lng };

  document.getElementById('reportLocationCoords').textContent =
    `Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)}`;

  document.getElementById('reportModal').style.display = 'block';
}

function closeReportModal(e) {
  if (e && e.target.id !== 'reportModal') return;
  document.getElementById('reportModal').style.display = 'none';
  currentReportLatLng = null;
  removeImage();
}


function goHome() {
  window.location.href = "index.html";
}

function handleImageUpload(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = () => {
    currentReportImageBase64 = reader.result;

    document.getElementById('previewImg').src = reader.result;
    document.getElementById('uploadPrompt').style.display = 'none';
    document.getElementById('imagePreview').style.display = 'block';
    document.getElementById('photoUploadArea').classList.add('has-image');
  };

  reader.readAsDataURL(file);
}

function removeImage(e) {
  if (e) e.stopPropagation();
  currentReportImageBase64 = null;
  document.getElementById('photoInput').value = '';
  document.getElementById('uploadPrompt').style.display = 'block';
  document.getElementById('imagePreview').style.display = 'none';
  document.getElementById('photoUploadArea').classList.remove('has-image');
}

function updateStats(data) {
  stats = { high: 0, medium: 0, low: 0 };
  data.features.forEach(f => {
    const risk = f && f.properties && f.properties.Risk ? String(f.properties.Risk).toLowerCase().trim() : '';
    if (stats[risk] !== undefined) stats[risk]++;
  });
  document.getElementById('highCount').textContent = stats.high;
  document.getElementById('mediumCount').textContent = stats.medium;
  document.getElementById('lowCount').textContent = stats.low;
}

fetch("data.geojson")
  .then(res => res.json())
  .then(data => {

    updateStats(data);
    priorityLocations = data.features.filter(f => f.properties.Risk === "High");

    const list = document.getElementById("locationList");
    priorityLocations.forEach((f, i) => {
      const div = document.createElement("div");
      div.className = "location-item";
      div.innerHTML = `<span class="location-number">${i + 1}</span>${f.properties.Location_Road}`;
      div.onclick = () => focusOnLocation(i);
      list.appendChild(div);
    });

geojsonLayer = L.geoJSON(data, {
  pointToLayer: (f, latlng) =>
    L.circleMarker(latlng, {
      radius: getRadius(),
      fillColor: getColor(f.properties.Risk),
      fillOpacity: 0.85,
      color: "#ffffff",
      weight: 2
    }),
  onEachFeature: (f, layer) => {
    layer.bindPopup(
      `<div style="font-family: Inter, sans-serif; padding: 8px;">
        <h4 style="margin: 0 0 8px 0; color: #1e293b; font-size: 16px; font-weight: 700;">
          ${f.properties.Location_Road}
        </h4>
        <p style="margin: 0; color: #64748b; font-size: 14px; font-weight: 600;">
          <span style="color: ${getColor(f.properties.Risk)}; font-weight: 800;">
            ${f.properties.Risk}
          </span> Risk Area
        </p>
      </div>`
    );
  }
});

// ‚úÖ ADD GEOJSON INTO LAYER GROUP (NOT MAP)
geojsonLayerGroup.addLayer(geojsonLayer);
geojsonLayerGroup.addTo(map);


    // Load and display approved user reports
    loadApprovedReports();

    updateLegend();
  });
function loadApprovedReports() {
  const approvedLocations = JSON.parse(localStorage.getItem('approvedLocations') || '[]');

  approvedLocations.forEach(report => {

    report.createdAt =
      report.createdAt ||
      new Date(report.timestamp).getTime() ||
      Date.now();

    const severityMap = {
      low: { color: '#fde68a', label: 'Low', icon: '‚ö†Ô∏è' },
      medium: { color: '#f97316', label: 'Medium', icon: 'üü†' },
      high: { color: '#dc2626', label: 'High', icon: 'üî¥' }
    };

    const severity =
      severityMap[report.severity?.toLowerCase()] || severityMap.medium;

    const ageMinutes = minutesSince(report.createdAt);

    let marker;

    if (ageMinutes < REPORT_EXPIRY_MINUTES) {

      const pulseClass =
        report.severity === 'high' ? 'pulse-high' :
        report.severity === 'medium' ? 'pulse-medium' :
        'pulse-low';

      const icon = L.divIcon({
        className: '',
        html: `<div class="${pulseClass}"></div>`,
        iconSize: [16, 16]
      });

      marker = L.marker([report.lat, report.lng], { icon }).addTo(markerLayer);

      reportMarkers.push({
        marker,
        createdAt: report.createdAt
      });
    }

    else {
      marker = L.circleMarker([report.lat, report.lng], {
        radius: getRadius(),
        fillColor: severity.color,
        fillOpacity: 0.85,
        color: "#ffffff",
        weight: 2
      }).addTo(map);
    }

    marker.bindPopup(
      `<div style="font-family: Inter, sans-serif; padding: 10px;">
        <h4 style="margin: 0 0 8px 0; color: #1e293b; font-size: 16px; font-weight: 700;">
          ${severity.icon} ${report.location}
        </h4>
        <p style="margin: 0 0 4px 0; color: #64748b; font-size: 14px; font-weight: 600;">
          <span style="color: ${severity.color}; font-weight: 800;">
            ${severity.label}
          </span> Risk Area
        </p>
        <p style="margin: 0 0 4px 0; color: #10b981; font-size: 12px; font-weight: 600;">
          ‚úì Verified Report
        </p>
        <p style="margin: 4px 0 0 0; color: #94a3b8; font-size: 11px;">
          ID: ${report.id}
        </p>
        <p style="margin: 2px 0 0 0; color: #94a3b8; font-size: 10px;">
          ${report.timestamp}
        </p>
      </div>`,
      { className: 'custom-popup' }
    );

    const severityLower = report.severity?.toLowerCase();
    if (stats[severityLower] !== undefined) {
      stats[severityLower]++;
    }
  });

  document.getElementById('highCount').textContent = stats.high;
  document.getElementById('mediumCount').textContent = stats.medium;
  document.getElementById('lowCount').textContent = stats.low;
}


function setRain(level) {
  rainLevel = level;
  geojsonLayer.setStyle(f => ({
    fillColor: getColor(f.properties.Risk),
    radius: getRadius()
  }));
  updateLegend();
}

function updateLegend() {
  document.querySelector(".low").style.background =
    rainLevel === "Heavy" ? "#dc2626" :
    rainLevel === "Moderate" ? "#f97316" : "#fde68a";

  document.querySelector(".medium").style.background =
    rainLevel === "Light" ? "#f97316" : "#dc2626";

  document.querySelector(".high").style.background = "#dc2626";
}

function submitReport() {
  console.log('Checking duplicate at:', currentReportLatLng);

  if (!currentReportLatLng) {
    showWarningModal('Error', 'Please select a location first');
    return;
  }

  const nearbyCheck = hasNearbyReport(
    currentReportLatLng.lat,
    currentReportLatLng.lng,
    100
  );

  if (nearbyCheck.found) {
    showDuplicateWarning(nearbyCheck.reports);
    return;
  }

  const locationName = document.getElementById('reportLocationName').value.trim();
  const description = document.getElementById('reportDescription').value.trim();
  const severity = document.getElementById('severitySelect').value.toLowerCase();

  if (!locationName) {
    showWarningModal('Missing Information', 'Please provide a location name');
    return;
  }

const report = {
  id: 'WL-' + new Date().getFullYear() + '-' + Date.now().toString().slice(-6),
  location: locationName,
  description,
  lat: Number(currentReportLatLng.lat),
  lng: Number(currentReportLatLng.lng),
  severity,
  status: 'pending',
  image: currentReportImageBase64,
  timestamp: new Date().toLocaleString('en-IN'),
  createdAt: Date.now()
};

  const reports = JSON.parse(localStorage.getItem('waterloggingReports') || '[]');
  reports.push(report);
  localStorage.setItem('waterloggingReports', JSON.stringify(reports));

  L.circleMarker([report.lat, report.lng], {
    radius: 10,
    fillColor: '#94a3b8',
    fillOpacity: 0.6,
    color: '#ffffff',
    weight: 3,
    dashArray: '5,5'
  }).addTo(map);

  closeReportModal();
  showSuccessModal('Report Submitted', 'Your waterlogging report has been submitted successfully!');
}

function showDuplicateWarning(reports) {
  let reportsHTML = '';
  
  reports.forEach((report, index) => {
    const statusBadge = report.status === 'approved' ? 
      '<span style="background: #10b981; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">‚úì VERIFIED</span>' :
      report.status === 'official' ?
      '<span style="background: #3b82f6; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">OFFICIAL</span>' :
      '<span style="background: #f59e0b; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">PENDING</span>';
    
    const severityColor = report.severity === 'high' ? '#dc2626' : 
                          report.severity === 'medium' ? '#f97316' : '#fde68a';
    
    reportsHTML += `
      <div style="background: #f8fafc; border-left: 4px solid ${severityColor}; padding: 12px; margin: 8px 0; border-radius: 6px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
          <strong style="color: #1e293b; font-size: 14px;">${report.location}</strong>
          ${statusBadge}
        </div>
        <div style="color: #64748b; font-size: 13px; margin-bottom: 4px;">
          <span style="color: ${severityColor}; font-weight: 700; text-transform: uppercase;">${report.severity}</span> severity
        </div>
        <div style="color: #94a3b8; font-size: 12px;">
          üìç ${report.distance} meters away
        </div>
      </div>
    `;
  });
  
  const warningHTML = `
    <div id="duplicateWarningModal" style="
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      backdrop-filter: blur(4px);
    ">
      <div style="
        background: white;
        border-radius: 16px;
        max-width: 500px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        animation: slideIn 0.3s ease-out;
      ">
        <div style="
          background: linear-gradient(135deg, #dc2626 0%, #f97316 100%);
          padding: 24px;
          border-radius: 16px 16px 0 0;
          text-align: center;
        ">
          <div style="font-size: 48px; margin-bottom: 8px;">‚ö†Ô∏è</div>
          <h2 style="margin: 0; color: white; font-size: 24px; font-weight: 800;">Duplicate Report Detected</h2>
        </div>
        
        <div style="padding: 24px;">
          <p style="color: #475569; font-size: 15px; line-height: 1.6; margin: 0 0 16px 0;">
            <strong>Waterlogging has already been reported in this area.</strong> To avoid duplicate reports, please check existing reports within a 100-meter radius:
          </p>
          
          <div style="margin: 20px 0;">
            ${reportsHTML}
          </div>
          
          <div style="background: #fef3c7; border: 1px solid #fbbf24; padding: 12px; border-radius: 8px; margin: 16px 0;">
            <p style="margin: 0; color: #92400e; font-size: 13px; line-height: 1.5;">
              <strong>üí° Tip:</strong> Check the map for existing markers before submitting a new report. This helps us maintain accurate data.
            </p>
          </div>
          
          <div style="display: flex; gap: 12px; margin-top: 20px;">
            <button onclick="closeDuplicateWarning()" style="
              flex: 1;
              padding: 14px;
              background: #1e293b;
              color: white;
              border: none;
              border-radius: 8px;
              font-size: 15px;
              font-weight: 700;
              cursor: pointer;
              transition: all 0.2s;
            " onmouseover="this.style.background='#334155'" onmouseout="this.style.background='#1e293b'">
              Got It
            </button>
            <button onclick="viewNearbyReports()" style="
              flex: 1;
              padding: 14px;
              background: white;
              color: #1e293b;
              border: 2px solid #1e293b;
              border-radius: 8px;
              font-size: 15px;
              font-weight: 700;
              cursor: pointer;
              transition: all 0.2s;
            " onmouseover="this.style.background='#f1f5f9'" onmouseout="this.style.background='white'">
              View on Map
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <style>
      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(-20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  `;
  
  const existingModal = document.getElementById('duplicateWarningModal');
  if (existingModal) {
    existingModal.remove();
  }
  
  document.body.insertAdjacentHTML('beforeend', warningHTML);
}

function closeDuplicateWarning() {
  const modal = document.getElementById('duplicateWarningModal');
  if (modal) {
    modal.style.animation = 'slideOut 0.2s ease-in';
    setTimeout(() => modal.remove(), 200);
  }
}

function viewNearbyReports() {
  closeDuplicateWarning();
  closeReportModal();
  
  if (currentReportLatLng) {
    map.setView([currentReportLatLng.lat, currentReportLatLng.lng], 15);
  }
}

function showSuccessModal(title, message) {
  const successHTML = `
    <div id="successModal" style="
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
    ">
      <div style="
        background: white;
        border-radius: 12px;
        padding: 32px;
        text-align: center;
        max-width: 400px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      ">
        <div style="font-size: 56px; margin-bottom: 16px;">‚úÖ</div>
        <h2 style="margin: 0 0 12px 0; color: #1e293b; font-size: 22px; font-weight: 800;">${title}</h2>
        <p style="margin: 0 0 24px 0; color: #64748b; font-size: 15px;">${message}</p>
        <button onclick="closeSuccessModal()" style="
          padding: 12px 32px;
          background: #10b981;
          color: white;
          border: none;
          border-radius: 8px;
          font-size: 15px;
          font-weight: 700;
          cursor: pointer;
        ">OK</button>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', successHTML);
}

function closeSuccessModal() {
  const modal = document.getElementById('successModal');
  if (modal) modal.remove();
}

function showWarningModal(title, message) {
  const warningHTML = `
    <div id="warningModal" style="
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
    ">
      <div style="
        background: white;
        border-radius: 12px;
        padding: 32px;
        text-align: center;
        max-width: 400px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      ">
        <div style="font-size: 56px; margin-bottom: 16px;">‚ö†Ô∏è</div>
        <h2 style="margin: 0 0 12px 0; color: #1e293b; font-size: 22px; font-weight: 800;">${title}</h2>
        <p style="margin: 0 0 24px 0; color: #64748b; font-size: 15px;">${message}</p>
        <button onclick="closeWarningModal()" style="
          padding: 12px 32px;
          background: #f97316;
          color: white;
          border: none;
          border-radius: 8px;
          font-size: 15px;
          font-weight: 700;
          cursor: pointer;
        ">OK</button>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', warningHTML);
}

function closeWarningModal() {
  const modal = document.getElementById('warningModal');
  if (modal) modal.remove();
}

function focusOnLocation(index) {
  closeModal();
  const f = priorityLocations[index];
  const [lng, lat] = f.geometry.coordinates;
  map.setView([lat, lng], 15);

  setTimeout(() => {
    L.circleMarker([lat, lng], {
      radius: 16,
      fillColor: "#dc2626",
      fillOpacity: 0.9,
      color: "#ffffff",
      weight: 3
    }).addTo(map)
      .bindPopup(
        `<div style="font-family: Inter, sans-serif; padding: 12px;">
          <h3 style="margin: 0 0 8px 0; color: #dc2626; font-size: 18px; font-weight: 800;">üö® CRITICAL ZONE</h3>
          <h4 style="margin: 0 0 4px 0; color: #1e293b; font-size: 16px; font-weight: 700;">${f.properties.Location_Road}</h4>
          <p style="margin: 0; color: #64748b; font-size: 14px; font-weight: 600;">Requires Immediate Attention</p>
        </div>`
      )
      .openPopup();
  }, 300);
}

function openModal() {
  document.getElementById("modal").style.display = "block";
}

function closeModal(e) {
  if (e && e.target.id !== "modal") return;
  document.getElementById("modal").style.display = "none";
}


const style = document.createElement('style');
style.textContent = `
  .leaflet-popup-content-wrapper {
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.8);
  }
  .leaflet-popup-tip {
    display: none;
  }
  
  @keyframes slideOut {
    from {
      opacity: 1;
      transform: translateY(0);
    }
    to {
      opacity: 0;
      transform: translateY(-20px);
    }
  }
`;
setInterval(() => {
  reportMarkers = reportMarkers.filter(r => {
    if (minutesSince(r.createdAt) >= REPORT_EXPIRY_MINUTES) {
      const el = r.marker.getElement();
      if (el && !el.classList.contains('fade-out')) {
        el.classList.add('fade-out');
        setTimeout(() => map.removeLayer(r.marker), 2000);
      }
      return false;
    }
    return true;
  });
}, 60 * 1000);

document.head.appendChild(style);

async function loadReportsFromDB() {
  try {
    const res = await fetch(`${API_BASE_URL}/api/reports`);
    const reports = await res.json();

    markerLayer.clearLayers();
    heatLayerGroup.clearLayers();

    const heatPoints = [];

    reports.forEach(report => {
      if (!report.lat || !report.lng) return;

      const severity = report.severity?.toLowerCase();
      const weight =
        severity === "high" ? 1.0 :
        severity === "medium" ? 0.6 : 0.3;

      heatPoints.push([report.lat, report.lng, weight]);

      L.circleMarker([report.lat, report.lng], {
        radius: 9,
        fillColor:
          severity === "high" ? "#dc2626" :
          severity === "medium" ? "#f97316" : "#fde68a",
        fillOpacity: 0.9,
        color: "#ffffff",
        weight: 2
      }).addTo(markerLayer);
    });

    heatLayer = L.heatLayer(heatPoints, {
      radius: 35,
      blur: 25,
      maxZoom: 15,
      gradient: {
        0.3: "#fde68a",
        0.6: "#f97316",
        1.0: "#dc2626"
      }
    });

    heatLayerGroup.addLayer(heatLayer);

  } catch (err) {
    console.error("Heatmap error:", err);
  }
}






loadReportsFromDB();
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Urban Flood Risk Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<style>
  .low {
  background: #fde68a;
}

.medium {
  background: #f97316;
}

.high {
  background: #dc2626;
}

* { 
  box-sizing: border-box; 
  margin: 0;
  padding: 0;
}


body {
  font-family: 'Inter', sans-serif;
  height: 100vh;
  display: flex;
  flex-direction: column;
  background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
  overflow: hidden;
}

/* ANIMATED BACKGROUND PATTERN */
body::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: 
    radial-gradient(circle at 20% 50%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
    radial-gradient(circle at 80% 80%, rgba(16, 185, 129, 0.1) 0%, transparent 50%),
    radial-gradient(circle at 40% 20%, rgba(139, 92, 246, 0.1) 0%, transparent 50%);
  animation: drift 20s ease-in-out infinite;
  pointer-events: none;
}

@keyframes drift {
  0%, 100% { transform: translate(0, 0); }
  50% { transform: translate(30px, 30px); }
}

/* HEADER */
header {
  background: rgba(15, 23, 42, 0.95);
  backdrop-filter: blur(20px);
  color: white;
  padding: 20px 32px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
  position: relative;
  z-index: 10;
  border-bottom: 1px solid rgba(59, 130, 246, 0.2);
}

header::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  height: 2px;
  background: linear-gradient(90deg, 
    transparent,
    #3b82f6 20%,
    #06b6d4 40%,
    #10b981 60%,
    #8b5cf6 80%,
    transparent
  );
  animation: shimmer 3s linear infinite;
}

@keyframes shimmer {
  0% { transform: translateX(-100%); }
  100% { transform: translateX(100%); }
}

... (file continues identical to map.html except the two report buttons removed)
