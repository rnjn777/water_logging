<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Urban Flood Risk Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<style>
  .low {
  background: #fde68a;
}

.medium {
  background: #f97316;
}

.high {
  background: #dc2626;
}
.locate-btn {
  background: white;
  width: 38px;
  height: 38px;
  border-radius: 10px;
  box-shadow: 0 4px 14px rgba(0,0,0,0.25);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 20px;
  border: none;
}

.locate-btn:hover {
  background: #eff6ff;
}

* { 
  box-sizing: border-box; 
  margin: 0;
  padding: 0;
}


body {
  font-family: 'Inter', sans-serif;
  height: 100vh;
  display: flex;
  flex-direction: column;
  background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
  overflow: hidden;
}

/* ANIMATED BACKGROUND PATTERN */
body::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: 
    radial-gradient(circle at 20% 50%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
    radial-gradient(circle at 80% 80%, rgba(16, 185, 129, 0.1) 0%, transparent 50%),
    radial-gradient(circle at 40% 20%, rgba(139, 92, 246, 0.1) 0%, transparent 50%);
  animation: drift 20s ease-in-out infinite;
  pointer-events: none;
}

@keyframes drift {
  0%, 100% { transform: translate(0, 0); }
  50% { transform: translate(30px, 30px); }
}


/* ==============================
   CRITICAL AREAS MODAL (FINAL)
   ============================== */

#modalContent {
  background: linear-gradient(135deg, #ffffff, #f8fafc);
  width: 500px;
  max-height: 75vh;
  margin: 8vh auto;
  border-radius: 20px;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  box-shadow: 0 25px 80px rgba(0, 0, 0, 0.4);
}

/* ==============================
   MODAL HEADER
   ============================== */

.modal-header {
  background: linear-gradient(135deg, #dc2626, #f97316);
  padding: 24px;
  text-align: center;
  flex-shrink: 0;
}

.modal-header h3 {
  margin: 0;
  color: #ffffff;
  font-size: 22px;
  font-weight: 900;
  letter-spacing: -0.3px;
}

.modal-subtitle {
  margin-top: 6px;
  font-size: 13px;
  font-weight: 600;
  color: rgba(255, 255, 255, 0.9);
}

/* ==============================
   CRITICAL LIST (SCROLLABLE)
   ============================== */

#locationList {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 14px;
}

/* ==============================
   CRITICAL ITEM CARD
   ============================== */

.critical-item {
  display: flex;
  align-items: center;
  gap: 14px;
  padding: 16px 18px;
  background: #ffffff;
  border-radius: 14px;
  cursor: pointer;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
  transition: all 0.25s ease;
  border: 2px solid transparent;
}

.critical-item:hover {
  transform: translateY(-2px);
  border-color: #fecaca;
  box-shadow: 0 14px 36px rgba(220, 38, 38, 0.25);
}

/* ==============================
   RANK BADGE
   ============================== */

.critical-rank {
  width: 38px;
  height: 38px;
  min-width: 38px;
  border-radius: 50%;
  background: linear-gradient(135deg, #dc2626, #ef4444);
  color: #ffffff;
  font-weight: 900;
  font-size: 15px;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 6px 18px rgba(220, 38, 38, 0.5);
}

/* ==============================
   LOCATION TEXT
   ============================== */

.critical-text {
  font-family: 'Inter', sans-serif;
  font-size: 16px;
  font-weight: 700;
  color: #1e293b;
  line-height: 1.4;
}

/* ==============================
   TOP PRIORITY HIGHLIGHT
   ============================== */

.critical-item:first-child {
  background: #fee2e2;
  border: 2px solid #fca5a5;
  animation: criticalPulse 2s infinite;
}

@keyframes criticalPulse {
  0% { box-shadow: 0 0 0 rgba(220,38,38,0.5); }
  50% { box-shadow: 0 0 22px rgba(220,38,38,0.9); }
  100% { box-shadow: 0 0 0 rgba(220,38,38,0.5); }
}

/* ==============================
   SCROLLBAR STYLING
   ============================== */

#locationList::-webkit-scrollbar {
  width: 6px;
}

#locationList::-webkit-scrollbar-thumb {
  background: linear-gradient(180deg, #f87171, #dc2626);
  border-radius: 10px;
}

#locationList::-webkit-scrollbar-track {
  background: transparent;
}


/* HEADER */
header {
  background: rgba(15, 23, 42, 0.95);
  backdrop-filter: blur(20px);
  color: white;
  padding: 20px 32px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
  position: relative;
  z-index: 10;
  border-bottom: 1px solid rgba(59, 130, 246, 0.2);
}

header::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  height: 2px;
  background: linear-gradient(90deg, 
    transparent,
    #3b82f6 20%,
    #06b6d4 40%,
    #10b981 60%,
    #8b5cf6 80%,
    transparent
  );
  animation: shimmer 3s linear infinite;
}

@keyframes shimmer {
  0% { transform: translateX(-100%); }
  100% { transform: translateX(100%); }
}

.header-content {
  display: flex;
  align-items: center;
  gap: 16px;
}

.logo-icon {
  font-size: 32px;
  animation: pulse 2s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.1); }
}

header h1 {
  font-size: 26px;
  font-weight: 800;
  background: linear-gradient(135deg, #ffffff, #60a5fa);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  letter-spacing: -0.5px;
}

.header-subtitle {
  font-size: 12px;
  color: #94a3b8;
  font-weight: 500;
  margin-top: 2px;
}

.critical-btn {
  background: linear-gradient(135deg, #dc2626, #ef4444);
  border: none;
  color: white;
  padding: 12px 24px;
  border-radius: 12px;
  font-weight: 700;
  cursor: pointer;
  box-shadow: 0 4px 20px rgba(220, 38, 38, 0.4);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  font-size: 14px;
  position: relative;
  overflow: hidden;
}

.critical-btn::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 0;
  height: 0;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.2);
  transform: translate(-50%, -50%);
  transition: width 0.6s, height 0.6s;
}

.critical-btn:hover::before {
  width: 300px;
  height: 300px;
}

.critical-btn:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 30px rgba(220, 38, 38, 0.6);
}

.critical-btn:active {
  transform: translateY(-1px);
}

/* CONTROLS BAR */
.controls {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(10px);
  padding: 16px 32px;
  display: flex;
  gap: 24px;
  align-items: center;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
  position: relative;
  z-index: 5;
  border-bottom: 1px solid rgba(226, 232, 240, 0.8);
}

.control-group {
  display: flex;
  align-items: center;
  gap: 12px;
}

.controls label {
  font-weight: 600;
  color: #1e293b;
  font-size: 14px;
  display: flex;
  align-items: center;
  gap: 8px;
}

select {
  padding: 10px 16px;
  border-radius: 10px;
  border: 2px solid #e2e8f0;
  font-weight: 600;
  font-size: 14px;
  transition: all 0.3s ease;
  background: white;
  cursor: pointer;
  color: #334155;
  min-width: 160px;
}

select:hover {
  border-color: #3b82f6;
  box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
}

select:focus {
  outline: none;
  border-color: #3b82f6;
  box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
}

.report-btn {
  background: linear-gradient(135deg, #3b82f6, #2563eb);
  color: white;
  border: none;
  padding: 11px 20px;
  border-radius: 10px;
  font-weight: 700;
  cursor: pointer;
  box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
  transition: all 0.3s ease;
  font-size: 14px;
}

.report-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
  background: linear-gradient(135deg, #2563eb, #1d4ed8);
}

/* MAP CONTAINER */
.map-wrapper {
  flex: 1;
  position: relative;
  margin: 16px;
  border-radius: 16px;
  overflow: hidden;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
  border: 1px solid rgba(255, 255, 255, 0.1);
}

#map {
  width: 100%;
  height: 100%;
}

/* LEGEND */
#legend {
  position: absolute;
  bottom: 30px;
  right: 30px;
  background: rgba(255, 255, 255, 0.98);
  backdrop-filter: blur(20px);
  padding: 14px 18px;
  border-radius: 12px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
  font-size: 13px;
  z-index: 1000;
  border: 1px solid rgba(255, 255, 255, 0.8);
  min-width: 150px;
}

.legend-title {
  font-weight: 700;
  color: #1e293b;
  margin-bottom: 10px;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.8px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.legend-item {
  display: flex;
  align-items: center;
  margin: 8px 0;
  font-weight: 600;
  color: #475569;
  transition: all 0.2s ease;
  padding: 3px;
  border-radius: 6px;
  font-size: 13px;
}

.legend-item:hover {
  background: rgba(59, 130, 246, 0.05);
  transform: translateX(4px);
}

.box {
  width: 16px;
  height: 16px;
  margin-right: 10px;
  border-radius: 5px;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
  transition: transform 0.2s ease;
}

.legend-item:hover .box {
  transform: scale(1.15);
}

/* STATS BAR */
.stats-bar {
  position: absolute;
  top: 20px;
  left: 20px;
  display: flex;
  gap: 10px;
  z-index: 1000;
}

.stat-card {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(10px);
  padding: 10px 14px;
  border-radius: 10px;
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
  border: 1px solid rgba(255, 255, 255, 0.8);
  min-width: 100px;
}

.stat-label {
  font-size: 10px;
  color: #64748b;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 3px;
}

.stat-value {
  font-size: 20px;
  font-weight: 800;
  color: #1e293b;
}

.stat-high { color: #dc2626; }
.stat-medium { color: #f97316; }
.stat-low { color: #10b981; }

/* MODAL */
#modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(15, 23, 42, 0.75);
  backdrop-filter: blur(12px);
  z-index: 2000;
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

#modalContent {
  background: linear-gradient(135deg, #ffffff, #f8fafc);
  width: 500px;
  max-height: 75vh;
  overflow: hidden;
  margin: 8vh auto;
  border-radius: 20px;
  box-shadow: 0 25px 80px rgba(0, 0, 0, 0.4);
  animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  border: 1px solid rgba(255, 255, 255, 0.8);
}

/* REPORT MODAL */
#reportModal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(15, 23, 42, 0.75);
  backdrop-filter: blur(12px);
  z-index: 2000;
  animation: fadeIn 0.3s ease;
}

#reportModalContent {
  background: linear-gradient(135deg, #ffffff, #f8fafc);
  width: 550px;
  max-width: 90%;
  max-height: 85vh;
  overflow: hidden;
  margin: 5vh auto;
  border-radius: 20px;
  box-shadow: 0 25px 80px rgba(0, 0, 0, 0.4);
  animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  border: 1px solid rgba(255, 255, 255, 0.8);
}

.report-modal-header {
  padding: 24px 28px;
  background: linear-gradient(135deg, #3b82f6, #2563eb);
  color: white;
  border-radius: 20px 20px 0 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.report-modal-header h3 {
  font-size: 22px;
  font-weight: 800;
  margin: 0;
  display: flex;
  align-items: center;
  gap: 10px;
}

.modal-close-btn {
  background: rgba(255, 255, 255, 0.2);
  border: none;
  color: white;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  font-size: 20px;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
}

.modal-close-btn:hover {
  background: rgba(255, 255, 255, 0.3);
  transform: rotate(90deg);
}

.report-form {
  padding: 28px;
  max-height: calc(85vh - 100px);
  overflow-y: auto;
}

.form-group {
  margin-bottom: 20px;
}

.form-label {
  display: block;
  font-weight: 700;
  color: #1e293b;
  margin-bottom: 8px;
  font-size: 14px;
}

.form-label .required {
  color: #dc2626;
  margin-left: 4px;
}

.form-input,
.form-textarea {
  width: 100%;
  padding: 12px 16px;
  border-radius: 10px;
  border: 2px solid #e2e8f0;
  font-family: 'Inter', sans-serif;
  font-size: 14px;
  transition: all 0.3s ease;
  background: white;
}

.form-input:focus,
.form-textarea:focus {
  outline: none;
  border-color: #3b82f6;
  box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
}

.form-textarea {
  resize: vertical;
  min-height: 80px;
}

.photo-upload-area {
  border: 2px dashed #cbd5e1;
  border-radius: 12px;
  padding: 24px;
  text-align: center;
  background: #f8fafc;
  transition: all 0.3s ease;
  cursor: pointer;
}

.photo-upload-area:hover {
  border-color: #3b82f6;
  background: #eff6ff;
}

.photo-upload-area.has-image {
  border-color: #10b981;
  background: #f0fdf4;
}

.upload-icon {
  font-size: 48px;
  margin-bottom: 12px;
}

.upload-text {
  color: #64748b;
  font-size: 14px;
  font-weight: 600;
  margin-bottom: 8px;
}

.upload-hint {
  color: #94a3b8;
  font-size: 12px;
}

.preview-image {
  max-width: 100%;
  max-height: 200px;
  border-radius: 8px;
  margin-top: 12px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.remove-image-btn {
  margin-top: 12px;
  background: #ef4444;
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  font-size: 12px;
  transition: all 0.3s ease;
}

.remove-image-btn:hover {
  background: #dc2626;
  transform: translateY(-2px);
}

.location-info {
  background: #eff6ff;
  border: 1px solid #bfdbfe;
  padding: 16px;
  border-radius: 10px;
  margin-bottom: 20px;
}

.location-info-title {
  font-weight: 700;
  color: #1e40af;
  font-size: 13px;
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.location-coords {
  color: #1e293b;
  font-size: 13px;
  font-family: 'Courier New', monospace;
}

.form-actions {
  display: flex;
  gap: 12px;
  margin-top: 24px;
}

.btn-submit,
.btn-cancel {
  flex: 1;
  padding: 14px 24px;
  border-radius: 12px;
  border: none;
  font-weight: 700;
  font-size: 15px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.btn-submit {
  background: linear-gradient(135deg, #3b82f6, #2563eb);
  color: white;
  box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
}

.btn-submit:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
}

.btn-submit:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.btn-cancel {
  background: #f1f5f9;
  color: #475569;
}

.btn-cancel:hover {
  background: #e2e8f0;
}

.report-form::-webkit-scrollbar {
  width: 8px;
}

.report-form::-webkit-scrollbar-track {
  background: #f1f5f9;
}

.report-form::-webkit-scrollbar-thumb {
  background: #cbd5e1;
  border-radius: 10px;
}

.report-form::-webkit-scrollbar-thumb:hover {
  background: #94a3b8;
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(50px) scale(0.95);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

.modal-header {
  padding: 24px 28px;
  background: linear-gradient(135deg, #dc2626, #ef4444);
  color: white;
  border-radius: 20px 20px 0 0;
}

.modal-header h3 {
  font-size: 22px;
  font-weight: 800;
  margin: 0;
  display: flex;
  align-items: center;
  gap: 10px;
}

.modal-subtitle {
  font-size: 13px;
  opacity: 0.9;
  margin-top: 6px;
  font-weight: 500;
}

#locationList {
  max-height: calc(75vh - 100px);
  overflow-y: auto;
  padding: 20px 28px;
}

#locationList::-webkit-scrollbar {
  width: 8px;
}

#locationList::-webkit-scrollbar-track {
  background: #f1f5f9;
}

#locationList::-webkit-scrollbar-thumb {
  background: #cbd5e1;
  border-radius: 10px;
}

#locationList::-webkit-scrollbar-thumb:hover {
  background: #94a3b8;
}

.location-item {
  padding: 16px 20px;
  cursor: pointer;
  border-radius: 12px;
  margin: 8px 0;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  color: #334155;
  font-weight: 600;
  background: white;
  border: 2px solid transparent;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

.location-item:hover {
  background: linear-gradient(135deg, #fef2f2, #fee2e2);
  border-color: #fca5a5;
  transform: translateX(8px) scale(1.02);
  box-shadow: 0 8px 20px rgba(220, 38, 38, 0.15);
}

.location-number {
  display: inline-block;
  width: 28px;
  height: 28px;
  background: linear-gradient(135deg, #dc2626, #ef4444);
  color: white;
  border-radius: 50%;
  text-align: center;
  line-height: 28px;
  font-size: 12px;
  font-weight: 700;
  margin-right: 12px;
}
.header-actions {
  display: flex;
  gap: 12px;
}

.rain-wave {
  z-index: 999 !important;
}


.home-btn {
  background: linear-gradient(135deg, #22c55e, #16a34a);
  color: white;
  border: none;
  padding: 10px 16px;
  border-radius: 10px;
  font-weight: 700;
  cursor: pointer;
  font-size: 14px;
  box-shadow: 0 4px 12px rgba(34, 197, 94, 0.35);
  transition: all 0.2s ease;
}

.home-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 18px rgba(34, 197, 94, 0.55);
}

/* ANIMATIONS */
.leaflet-interactive {
  transition: fill 0.3s ease, stroke 0.3s ease;
}

/* LOADING ANIMATION */
.loading {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
  color: white;
  z-index: 3000;
}
/* ===============================
   üåßÔ∏è ANIMATED RAIN WAVES
   =============================== */
.rain-wave {
  position: absolute;
  width: 14px;
  height: 14px;
  border-radius: 50%;
  pointer-events: none;
  opacity: 0.7;
  animation: rainWave 3s ease-out infinite;
}

.rain-low {
  background: rgba(253, 230, 138, 0.4);
}

.rain-medium {
  background: rgba(249, 115, 22, 0.45);
}

.rain-high {
  background: rgba(220, 38, 38, 0.5);
}

@keyframes rainWave {
  0% {
    transform: scale(0.3);
    opacity: 0.8;
  }
  100% {
    transform: scale(5);
    opacity: 0;
  }
}

.spinner {
  width: 50px;
  height: 50px;
  border: 4px solid rgba(255, 255, 255, 0.3);
  border-top: 4px solid #3b82f6;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}
/* ===============================
   LOW RISK (YELLOW)
   =============================== */
.pulse-low {
  width: 16px;
  height: 16px;
  background: #fde68a;
  border-radius: 50%;
  position: relative;
}

.pulse-low::after {
  content: '';
  position: absolute;
  inset: 0;
  border-radius: 50%;
  background: rgba(253, 230, 138, 0.6);
  animation: pulse-low 1.8s infinite ease-out;
}

@keyframes pulse-low {
  0% { transform: scale(1); opacity: 0.6; }
  100% { transform: scale(2.4); opacity: 0; }
}

/* ===============================
   MEDIUM RISK (ORANGE)
   =============================== */
.pulse-medium {
  width: 16px;
  height: 16px;
  background: #f97316;
  border-radius: 50%;
  position: relative;
}

.pulse-medium::after {
  content: '';
  position: absolute;
  inset: 0;
  border-radius: 50%;
  background: rgba(249, 115, 22, 0.6);
  animation: pulse-medium 1.5s infinite ease-out;
}

@keyframes pulse-medium {
  0% { transform: scale(1); opacity: 0.6; }
  100% { transform: scale(2.6); opacity: 0; }
}

/* ===============================
   HIGH RISK (RED)
   =============================== */
.pulse-high {
  width: 16px;
  height: 16px;
  background: #dc2626;
  border-radius: 50%;
  position: relative;
}

.pulse-high::after {
  content: '';
  position: absolute;
  inset: 0;
  border-radius: 50%;
  background: rgba(220, 38, 38, 0.6);
  animation: pulse-high 1.2s infinite ease-out;
}

@keyframes pulse-high {
  0% { transform: scale(1); opacity: 0.7; }
  100% { transform: scale(3); opacity: 0; }
}

</style>
</head>
<body>

<header>
  <div class="header-content">
    <div class="logo-icon">üåß</div>
    <div>
      <h1>Urban Flood Risk Dashboard</h1>
      <div class="header-subtitle">Real-time flood monitoring & analysis system</div>
    </div>
  </div>

  <div class="header-actions">
    <button class="home-btn" onclick="goHome()">üè† Home</button>
    <button class="critical-btn" onclick="openModal()">‚ö†Ô∏è Critical Areas</button>
  </div>
</header>


<div class="controls">
  <div class="control-group">
    <label>üå¶Ô∏è Rain Intensity:</label>
    <select onchange="setRain(this.value)">
      <option value="Light">üå§ Light Rain</option>
      <option value="Moderate">üåß Moderate Rain</option>
      <option value="Heavy">‚õà Heavy Rain</option>
    </select>
  </div>

  <div class="control-group">
    <label>üìä Report Severity:</label>
    <select id="severitySelect">
      <option value="Low">‚ö†Ô∏è Low</option>
      <option value="Medium">üü† Medium</option>
      <option value="High">üî¥ High</option>
    </select>
  </div>

  <div class="control-group">
    <label>üî• Waterlogging Heatmap:</label>
    <input type="checkbox" id="heatToggle" onchange="toggleHeatmap(this.checked)" checked />
  </div>
<button id="reportBtn" class="report-btn" onclick="enableReportMode()">‚ûï Report Waterlogging</button>
  <button id="reportMyLocationBtn" class="report-btn" onclick="reportCurrentLocation()" style="background: linear-gradient(135deg, #10b981, #059669);">üìç Report My Location</button>
  
</div>

<div class="map-wrapper">
  <div id="map"></div>
  
  <!-- Stats Bar -->
  <div class="stats-bar">
    <div class="stat-card">
      <div class="stat-label">High Risk</div>
      <div class="stat-value stat-high" id="highCount">0</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Medium Risk</div>
      <div class="stat-value stat-medium" id="mediumCount">0</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Low Risk</div>
      <div class="stat-value stat-low" id="lowCount">0</div>
    </div>
  </div>
  
  <!-- Legend -->
  <div id="legend">
    <div class="legend-title">üìä Risk Levels</div>
    <div class="legend-item"><span class="box low"></span> Low Risk</div>
    <div class="legend-item"><span class="box medium"></span> Medium Risk</div>
    <div class="legend-item"><span class="box high"></span> High Risk</div>
  </div>
</div>

<!-- MODAL -->
<div id="modal" onclick="closeModal(event)">
  <div id="modalContent" onclick="event.stopPropagation()">
    <div class="modal-header">
      <h3>üö® Critical Flood Zones</h3>
      <div class="modal-subtitle">Locations requiring immediate attention</div>
    </div>
    <div id="locationList"></div>
  </div>
</div>

<!-- REPORT MODAL -->
<div id="reportModal" onclick="closeReportModal(event)">
  <div id="reportModalContent" onclick="event.stopPropagation()">
    <div class="report-modal-header">
      <h3>üìç Report Waterlogging</h3>
      <button class="modal-close-btn" onclick="closeReportModal()">‚úï</button>
    </div>
    <div class="report-form">
      <div class="location-info">
        <div class="location-info-title">üìç Selected Location</div>
        <div class="location-coords" id="reportLocationCoords">Lat: 0.0000, Lng: 0.0000</div>
      </div>

      <div class="form-group">
        <label class="form-label">Location Name<span class="required">*</span></label>
        <input 
          type="text" 
          class="form-input" 
          id="reportLocationName"
          placeholder="Enter location name or nearby landmark..."
          required
        />
      </div>

      <div class="form-group">
        <label class="form-label">Description (Optional)</label>
        <textarea 
          class="form-textarea" 
          id="reportDescription"
          placeholder="Describe the waterlogging situation, depth, affected area, etc..."
        ></textarea>
      </div>

      <div class="form-group">
        <label class="form-label">Photo Proof (Optional)</label>
        <div class="photo-upload-area" id="photoUploadArea" onclick="document.getElementById('photoInput').click()">
          <div id="uploadPrompt">
            <div class="upload-icon">üì∑</div>
            <div class="upload-text">Click to upload photo</div>
            <div class="upload-hint">Maximum file size: 5MB | Supported: JPG, PNG</div>
          </div>
          <div id="imagePreview" style="display: none;">
            <img id="previewImg" class="preview-image" src="" alt="Preview">
            <button type="button" class="remove-image-btn" onclick="removeImage(event)">üóëÔ∏è Remove Photo</button>
          </div>
        </div>
        <input 
          type="file" 
          id="photoInput" 
          accept="image/*"
          style="display: none;"
          onchange="handleImageUpload(event)"
        />
      </div>

      <div class="form-actions">
        <button type="button" class="btn-cancel" onclick="closeReportModal()">Cancel</button>
        <button type="button" class="btn-submit" id="submitReportBtn" onclick="submitReport()">Submit Report</button>
      </div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

<script>
  const API_BASE_URL = "https://water-logging.onrender.com";
let rainWaveLayers = [];
let rainWaveTimer = null;
let rainLevel = "Light";
let geojsonLayer;
let reportMode = false;
let priorityLocations = [];
let stats = { high: 0, medium: 0, low: 0 };

let currentReportLocation = null;
let currentReportImage = null;
let currentReportLatLng = null;
let currentReportImageBase64 = null;
const REPORT_EXPIRY_MINUTES = 60;
let reportMarkers = [];
function minutesSince(ts) {
  return (Date.now() - ts) / (1000 * 60);
}
function recomputeAllStats() {
  stats = { high: 0, medium: 0, low: 0 };

  // 1Ô∏è‚É£ Official GeoJSON
  if (geojsonData && geojsonData.features) {
    geojsonData.features.forEach(f => {
      const risk = String(f.properties?.Risk || '').toLowerCase();
      if (stats[risk] !== undefined) stats[risk]++;
    });
  }

  // 2Ô∏è‚É£ Approved user reports
  const approved = JSON.parse(localStorage.getItem('approvedLocations') || '[]');
  approved.forEach(r => {
    const sev = String(r.severity || '').toLowerCase();
    if (stats[sev] !== undefined) stats[sev]++;
  });

  // 3Ô∏è‚É£ Server reports
  (serverReports || []).forEach(r => {
    const sev = String(r.severity || '').toLowerCase();
    if (stats[sev] !== undefined) stats[sev]++;
  });

  document.getElementById('highCount').textContent = stats.high;
  document.getElementById('mediumCount').textContent = stats.medium;
  document.getElementById('lowCount').textContent = stats.low;
}



let heatLayer = null;
let geojsonData = null;
let serverReports = [];



function startRainAnimation() {
  if (rainWaveTimer) clearInterval(rainWaveTimer);

  spawnRainWaves();

  const interval =
    rainLevel === 'Heavy' ? 3000 :
    rainLevel === 'Moderate' ? 4500 : 6000;

  rainWaveTimer = setInterval(spawnRainWaves, interval);
}

function severityToWeight(sev) {
  if (!sev) return 0.3;
  sev = sev.toLowerCase();

  if (sev === 'high') return 1.0;     // üî¥ red
  if (sev === 'medium') return 0.6;   // üü† orange
  return 0.3;                         // üü° yellow
}

function polygonCentroid(coords) {
  let lat = 0, lng = 0, n = 0;

  coords[0].forEach(([x, y]) => {
    lng += x;
    lat += y;
    n++;
  });

  return [lat / n, lng / n];
}


function updateHeatmap() {
  const low = [];
  const medium = [];
  const high = [];

  const rainMul =
    rainLevel === 'Heavy' ? 1.3 :
    rainLevel === 'Moderate' ? 1.1 : 1.0;

  function addPoint(lat, lng, risk) {
    if (risk === 'high') high.push([lat, lng, 1.0 * rainMul]);
    else if (risk === 'medium') medium.push([lat, lng, 0.8 * rainMul]);
    else low.push([lat, lng, 0.5 * rainMul]);
  }

  // GEOJSON
  geojsonData?.features?.forEach(f => {
    if (!f.geometry) return;
    const risk = f.properties?.Risk?.toLowerCase() || 'low';

    if (f.geometry.type === "Point") {
      const [lng, lat] = f.geometry.coordinates;
      addPoint(lat, lng, risk);
    } 
    else if (f.geometry.type === "Polygon") {
      const [lat, lng] = polygonCentroid(f.geometry.coordinates);
      addPoint(lat, lng, risk);
    }
    else if (f.geometry.type === "MultiPolygon") {
      f.geometry.coordinates.forEach(p => {
        const [lat, lng] = polygonCentroid(p);
        addPoint(lat, lng, risk);
      });
    }
  });

  // SERVER REPORTS
  (serverReports || []).forEach(r => {
    const lat = r.latitude ?? r.lat;
    const lng = r.longitude ?? r.lng;
    if (lat == null || lng == null) return;
    addPoint(lat, lng, r.severity?.toLowerCase());
  });

  // üî• REMOVE OLD LAYERS
  if (window.lowHeat) map.removeLayer(window.lowHeat);
  if (window.mediumHeat) map.removeLayer(window.mediumHeat);
  if (window.highHeat) map.removeLayer(window.highHeat);

  // üü° LOW
  window.lowHeat = L.heatLayer(low, {
    radius: 45,
    blur: 30,
    minOpacity: 0.3,
    gradient: { 0.0: '#fde68a', 1.0: '#fde68a' }
  });

  // üü† MEDIUM
  window.mediumHeat = L.heatLayer(medium, {
    radius: 50,
    blur: 35,
    minOpacity: 0.4,
    gradient: { 0.0: '#f97316', 1.0: '#f97316' }
  });

  // üî¥ HIGH
  window.highHeat = L.heatLayer(high, {
    radius: 55,
    blur: 40,
    minOpacity: 0.5,
    gradient: { 0.0: '#dc2626', 1.0: '#dc2626' }
  });

  if (document.getElementById('heatToggle')?.checked !== false) {
    lowHeat.addTo(map);
    mediumHeat.addTo(map);
    highHeat.addTo(map);
  }
}



function toggleHeatmap(show) {
  if (show) {
    if (window.lowHeat && !map.hasLayer(window.lowHeat)) {
      window.lowHeat.addTo(map);
      window.mediumHeat.addTo(map);
      window.highHeat.addTo(map);
    }
  } else {
    if (window.lowHeat && map.hasLayer(window.lowHeat)) {
      map.removeLayer(window.lowHeat);
      map.removeLayer(window.mediumHeat);
      map.removeLayer(window.highHeat);
    }
  }
}

function addPulsatingReportMarker(report) {
  const icon = L.divIcon({
    className: '',
    html: `<div class="pulse-marker"></div>`,
    iconSize: [16, 16]
  });

  const marker = L.marker([report.lat, report.lng], { icon }).addTo(map);

  reportMarkers.push({
    marker,
    createdAt: report.createdAt
  });

  // Handle already-expired reports (page reload case)
  setTimeout(() => {
    const el = marker.getElement();
    if (!el) return;

    if (minutesSince(report.createdAt) >= REPORT_EXPIRY_MINUTES) {
      el.classList.add('fade-out');
      setTimeout(() => map.removeLayer(marker), 2000);
    }
  }, 100);
}

const delhiBounds = L.latLngBounds(
  [28.40, 76.80],
  [28.95, 77.40]
);

function getDistanceInMeters(lat1, lng1, lat2, lng2) {
  const R = 6371000; // Earth radius in meters
  const toRad = deg => deg * Math.PI / 180;

  const dLat = toRad(lat2 - lat1);
  const dLng = toRad(lng2 - lng1);

  const a =
    Math.sin(dLat / 2) * Math.sin(dLat / 2) +
    Math.cos(toRad(lat1)) *
    Math.cos(toRad(lat2)) *
    Math.sin(dLng / 2) *
    Math.sin(dLng / 2);

  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return R * c;
}
function hasNearbyReport(lat, lng, radiusMeters = 100) {
  const reports = [];

  /* ============================
     1. CHECK PENDING REPORTS
     ============================ */
  const pending = JSON.parse(localStorage.getItem('waterloggingReports') || '[]');
  pending.forEach(r => {
    if (r.lat != null && r.lng != null) {
      const d = getDistanceInMeters(lat, lng, r.lat, r.lng);
      if (d <= radiusMeters) {
        reports.push({
          distance: Math.round(d),
          location: r.location || 'User Report',
          status: 'pending',
          severity: r.severity || 'unknown'
        });
      }
    }
  });

  /* ============================
     2. CHECK APPROVED REPORTS
     ============================ */
  const approved = JSON.parse(localStorage.getItem('approvedLocations') || '[]');
  approved.forEach(r => {
    if (r.lat != null && r.lng != null) {
      const d = getDistanceInMeters(lat, lng, r.lat, r.lng);
      if (d <= radiusMeters) {
        reports.push({
          distance: Math.round(d),
          location: r.location || 'Verified Report',
          status: 'approved',
          severity: r.severity || 'unknown'
        });
      }
    }
  });

  /* ============================
     3. CHECK OFFICIAL GEOJSON
     ============================ */
  if (geojsonLayer) {
    geojsonLayer.eachLayer(layer => {
      const ll = layer.getLatLng();
      const d = getDistanceInMeters(lat, lng, ll.lat, ll.lng);

      if (d <= radiusMeters) {
        const p = layer.feature.properties;
        reports.push({
          distance: Math.round(d),
          location: p.Location_Road || 'Official Waterlogging Area',
          status: 'official',
          severity: p.Risk ? p.Risk.toLowerCase() : 'unknown'
        });
      }
    });
  }

  if (reports.length > 0) {
    reports.sort((a, b) => a.distance - b.distance);
    return { found: true, reports };
  }

  return { found: false, reports: [] };
}


const map = L.map("map", {
  maxBounds: delhiBounds,
  maxBoundsViscosity: 1.0,
  minZoom: 10,
  maxZoom: 17,
  zoomControl: false
}).setView([28.6139, 77.2090], 11);

// Add zoom control to top right
L.control.zoom({ position: 'topright' }).addTo(map);
// üìç Locate Me button (bottom-left)
const locateControl = L.control({ position: 'bottomleft' });

locateControl.onAdd = function () {
  const btn = L.DomUtil.create('button', 'locate-btn');
  btn.innerHTML = 'üìç';

  L.DomEvent.on(btn, 'click', e => {
    L.DomEvent.stopPropagation(e);
    L.DomEvent.preventDefault(e);
    zoomToUserLocation();
  });

  return btn;
};

locateControl.addTo(map);

// Dark theme tile layer
L.tileLayer(
  "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",
  { 
    attribution: "¬© OpenStreetMap ¬© CARTO",
    maxZoom: 19
  }
).addTo(map);

function getColor(risk) {
  if (rainLevel === "Heavy") return "#dc2626";
  if (rainLevel === "Moderate") {
    if (risk !== "Low") return "#dc2626";
    return "#f97316";
  }
  if (risk === "High") return "#dc2626";
  if (risk === "Medium") return "#f97316";
  return "#fde68a";
}
let tempUserMarker = null;

function zoomToUserLocation() {
  if (!navigator.geolocation) {
    alert('Geolocation not supported');
    return;
  }

  navigator.geolocation.getCurrentPosition(
    pos => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;

      // Zoom map
      map.setView([lat, lng], 16, { animate: true });

      // üî• REMOVE old temp marker if exists
      if (tempUserMarker) {
        map.removeLayer(tempUserMarker);
        tempUserMarker = null;
      }

      // ‚úÖ TEMP marker (not stored)
      tempUserMarker = L.circleMarker([lat, lng], {
        radius: 10,
        fillColor: '#3b82f6',
        fillOpacity: 0.9,
        color: '#ffffff',
        weight: 3
      }).addTo(map);

      // ‚è± AUTO REMOVE after 3 seconds
      setTimeout(() => {
        if (tempUserMarker) {
          map.removeLayer(tempUserMarker);
          tempUserMarker = null;
        }
      }, 3000);
    },
    () => {
      alert('Location access denied');
    },
    {
      enableHighAccuracy: true,
      timeout: 10000
    }
  );
}

function getRadius() {
  return rainLevel === "Heavy" ? 10 :
         rainLevel === "Moderate" ? 9 : 8;
}

// üåßÔ∏è Get rainfall (last hour) ‚Äî use precipitation key (compat with Open-Meteo)
async function getRainfall(lat, lng) {
  const url =
    `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&hourly=precipitation&past_days=1`;

  const res = await fetch(url);
  const data = await res.json();

  const rainArr = data.hourly?.precipitation || [];
  return rainArr.length ? rainArr[rainArr.length - 1] : 0;
}

// üèîÔ∏è Get elevation
async function getElevation(lat, lng) {
  const url =
    `https://api.open-meteo.com/v1/elevation?latitude=${lat}&longitude=${lng}`;

  const res = await fetch(url);
  const data = await res.json();

  return data.elevation?.[0] ?? 50;
}

// üßÆ Flood risk formula
function calculateFloodRisk(rainfall, elevation) {
  let elevationFactor;

  if (elevation < 10) elevationFactor = 100;
  else if (elevation < 30) elevationFactor = 60;
  else elevationFactor = 20;

  let score = (rainfall * 0.6) + (elevationFactor * 0.4);
  return Math.min(100, Math.round(score));
}

function enableReportMode() {
  map.getContainer().style.cursor = 'crosshair';

  map.once('click', async function (e) {
    map.getContainer().style.cursor = '';

    const lat = e.latlng.lat;
    const lng = e.latlng.lng;

    // 1Ô∏è‚É£ Check duplicates (existing logic)
    const check = hasNearbyReport(lat, lng, 100);
    if (check.found) {
      showDuplicateWarning(check.reports);
      return;
    }

    try {
      // 2Ô∏è‚É£ Fetch data
      const rainfall = await getRainfall(lat, lng);
      const elevation = await getElevation(lat, lng);

      // 3Ô∏è‚É£ Calculate risk
      const riskScore = calculateFloodRisk(rainfall, elevation);

      // 4Ô∏è‚É£ Show result BEFORE report
      showFloodRiskModal(riskScore, rainfall, elevation);

      // 5Ô∏è‚É£ Continue to report form
      openReportModal(lat, lng, false);

    } catch (err) {
      console.error("Flood risk error:", err);
      alert("Failed to calculate flood risk");
      openReportModal(lat, lng, false);
    }
  });
}
function showFloodRiskModal(score, rain, elevation) {
  const level =
    score > 70 ? "üî¥ HIGH RISK" :
    score > 40 ? "üü† MEDIUM RISK" :
    "üü¢ LOW RISK";

  const html = `
    <div id="riskModal" style="
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    ">
      <div style="
        background: white;
        padding: 24px;
        border-radius: 14px;
        max-width: 360px;
        text-align: center;
        font-family: Inter;
      ">
        <h2>Flood Risk Analysis</h2>
        <h1>${level}</h1>
        <p><strong>Risk Score:</strong> ${score}/100</p>
        <p>üåß Rainfall: ${rain} mm</p>
        <p>üèî Elevation: ${elevation} m</p>
        <button onclick="document.getElementById('riskModal').remove()"
          style="margin-top: 12px; padding: 10px 20px; font-weight: 700;">
          Continue
        </button>
      </div>
    </div>
  `;

  document.body.insertAdjacentHTML("beforeend", html);
}


function reportCurrentLocation() {
  if (!navigator.geolocation) return;

  navigator.geolocation.getCurrentPosition(pos => {
    const lat = pos.coords.latitude;
    const lng = pos.coords.longitude;

    map.setView([lat, lng], 16);

    const check = hasNearbyReport(lat, lng, 100);
    if (check.found) {
      showDuplicateWarning(check.reports);
      return; // üö´ NO FORM
    }

    openReportModal(lat, lng, true);
  });
}
async function fetchFloodRisk(lat, lng) {
  const res = await fetch(`${API_BASE_URL}/api/risk?lat=${lat}&lng=${lng}`);
  const data = await res.json();
  if (!res.ok) throw new Error(data.message || 'Failed to fetch flood risk');
  return data;
}

function openReportModal(lat, lng, isGPS) {
  currentReportLatLng = { lat, lng };

  document.getElementById('reportLocationCoords').textContent =
    `Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)}`;

  document.getElementById('reportModal').style.display = 'block';
}

function closeReportModal(e) {
  if (e && e.target.id !== 'reportModal') return;
  document.getElementById('reportModal').style.display = 'none';
  currentReportLatLng = null;
  removeImage();
}


function goHome() {
  window.location.href = "index.html";
}

function handleImageUpload(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = () => {
    currentReportImageBase64 = reader.result;

    document.getElementById('previewImg').src = reader.result;
    document.getElementById('uploadPrompt').style.display = 'none';
    document.getElementById('imagePreview').style.display = 'block';
    document.getElementById('photoUploadArea').classList.add('has-image');
  };

  reader.readAsDataURL(file);
}

function removeImage(e) {
  if (e) e.stopPropagation();
  currentReportImageBase64 = null;
  document.getElementById('photoInput').value = '';
  document.getElementById('uploadPrompt').style.display = 'block';
  document.getElementById('imagePreview').style.display = 'none';
  document.getElementById('photoUploadArea').classList.remove('has-image');
}

function updateStats(data) {
  // Start with geojson counts
  stats = { high: 0, medium: 0, low: 0 };
  data.features.forEach(f => {
    const risk = (f.properties.Risk || '').toLowerCase();
    if (stats[risk] !== undefined) stats[risk]++;
  });
  updateStatsDisplay();
}

function updateStatsDisplay() {
  document.getElementById('highCount').textContent = stats.high;
  document.getElementById('mediumCount').textContent = stats.medium;
  document.getElementById('lowCount').textContent = stats.low;
}
fetch("data.geojson")
  .then(res => res.json())
  .then(data => {

    geojsonData = data;           // ‚úÖ Store globally
    recomputeAllStats();          // ‚úÖ Count official points

    priorityLocations = data.features.filter(
      f => f.properties.Risk === "High"
    );

const list = document.getElementById("locationList");
list.innerHTML = ""; // ‚úÖ clear old items

priorityLocations.slice(0, 5).forEach((f, i) => {
  const div = document.createElement("div");

  // ‚úÖ CORRECT CLASS (matches CSS)
  div.className = "critical-item";

  div.innerHTML = `
    <div class="critical-rank">${i + 1}</div>
    <div class="critical-text">${f.properties.Location_Road}</div>
  `;

  // ‚úÖ zoom safely
  div.onclick = () => {
    closeModal();
    const [lng, lat] = f.geometry.coordinates;
    map.setView([lat, lng], 16);
  };

  list.appendChild(div);
});



    geojsonLayer = L.geoJSON(data, {
      pointToLayer: (f, latlng) =>
        L.circleMarker(latlng, {
          radius: getRadius(),
          fillColor: getColor(f.properties.Risk),
          fillOpacity: 0.85,
          color: "#ffffff",
          weight: 2
        }),
      onEachFeature: (f, layer) => {
        layer.bindPopup(
          `<div style="font-family: Inter, sans-serif; padding: 8px;">
            <h4 style="margin: 0 0 8px 0; color: #1e293b; font-size: 16px; font-weight: 700;">
              ${f.properties.Location_Road}
            </h4>
            <p style="margin: 0; color: #64748b; font-size: 14px; font-weight: 600;">
              <span style="color: ${getColor(f.properties.Risk)}; font-weight: 800;">
                ${f.properties.Risk}
              </span> Risk Area
            </p>
          </div>`,
          { className: 'custom-popup' }
        );
      }
    }).addTo(map);

    loadApprovedReports();   // ‚úÖ markers only
    recomputeAllStats();     // ‚úÖ final correct counts

    updateLegend();
    updateHeatmap();
  });




function setRain(level) {
  rainLevel = level;

  geojsonLayer.setStyle(f => ({
    fillColor: getColor(f.properties.Risk),
    radius: getRadius()
  }));

  updateLegend();
  updateHeatmap();
  startRainAnimation(); // üåßÔ∏è ADD THIS
}


function updateLegend() {
  document.querySelector(".low").style.background =
    rainLevel === "Heavy" ? "#dc2626" :
    rainLevel === "Moderate" ? "#f97316" : "#fde68a";

  document.querySelector(".medium").style.background =
    rainLevel === "Light" ? "#f97316" : "#dc2626";

  document.querySelector(".high").style.background = "#dc2626";
}
function compressImage(base64String) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.onload = () => {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');

      // Calculate new dimensions (max 800px width/height)
      let { width, height } = img;
      const maxSize = 800;

      if (width > height) {
        if (width > maxSize) {
          height = (height * maxSize) / width;
          width = maxSize;
        }
      } else {
        if (height > maxSize) {
          width = (width * maxSize) / height;
          height = maxSize;
        }
      }

      canvas.width = width;
      canvas.height = height;

      // Draw and compress
      ctx.drawImage(img, 0, 0, width, height);

      // Compress to JPEG with 0.8 quality
      const compressedBase64 = canvas.toDataURL('image/jpeg', 0.8);
      resolve(compressedBase64);
    };

    img.onerror = reject;
    img.src = base64String;
  });
}

async function submitReport() {
  if (!currentReportLatLng) {
    showWarningModal("Error", "Please select a location first");
    return;
  }

  const locationName = document.getElementById("reportLocationName").value.trim();
  const severity = document.getElementById("severitySelect").value.toLowerCase();

  if (!locationName) {
    showWarningModal("Missing Info", "Enter location name");
    return;
  }

  const token = localStorage.getItem("token");

  if (!token) {
    showWarningModal("Login Required", "Please login first");
    return;
  }

  // Show loading state
  const submitBtn = document.getElementById("submitReportBtn");
  const originalText = submitBtn.textContent;
  submitBtn.textContent = "Submitting...";
  submitBtn.disabled = true;

  // Compress image if present
  let processedImageBase64 = currentReportImageBase64;
  if (currentReportImageBase64) {
    try {
      processedImageBase64 = await compressImage(currentReportImageBase64);
    } catch (err) {
      console.warn("Image compression failed, using original:", err);
    }
  }

  const payload = {
    latitude: Number(currentReportLatLng.lat),
    longitude: Number(currentReportLatLng.lng),
    location: locationName,
    severity,
    rainIntensity: "medium",
    imageBase64: processedImageBase64 || null
  };

  console.log("Submitting report...", {
    hasImage: !!processedImageBase64,
    imageSize: processedImageBase64?.length || 0
  });

  try {
    // Add timeout to prevent hanging
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout

    const res = await fetch(`${API_BASE_URL}/api/reports`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${token}`
      },
      body: JSON.stringify(payload),
      signal: controller.signal
    });

    clearTimeout(timeoutId);
    const data = await res.json();

    if (!res.ok) {
      throw new Error(data.message || "Submit failed");
    }

    showSuccessModal("Success", "Report submitted successfully");
    closeReportModal();
    loadReportsFromDB(); // refresh map
  } catch (err) {
    console.error("Submit error:", err);
    if (err.name === 'AbortError') {
      showWarningModal("Timeout", "Request timed out. Please try again.");
    } else {
      showWarningModal("Error", err.message || "Failed to submit report");
    }
  } finally {
    // Reset button state
    submitBtn.textContent = originalText;
    submitBtn.disabled = false;
  }
}


function showDuplicateWarning(reports) {
  let reportsHTML = '';
  
  reports.forEach((report, index) => {
    const statusBadge = report.status === 'approved' ? 
      '<span style="background: #10b981; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">‚úì VERIFIED</span>' :
      report.status === 'official' ?
      '<span style="background: #3b82f6; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">OFFICIAL</span>' :
      '<span style="background: #f59e0b; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">PENDING</span>';
    
    const severityColor = report.severity === 'high' ? '#dc2626' : 
                          report.severity === 'medium' ? '#f97316' : '#fde68a';
    
    reportsHTML += `
      <div style="background: #f8fafc; border-left: 4px solid ${severityColor}; padding: 12px; margin: 8px 0; border-radius: 6px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
          <strong style="color: #1e293b; font-size: 14px;">${report.location}</strong>
          ${statusBadge}
        </div>
        <div style="color: #64748b; font-size: 13px; margin-bottom: 4px;">
          <span style="color: ${severityColor}; font-weight: 700; text-transform: uppercase;">${report.severity}</span> severity
        </div>
        <div style="color: #94a3b8; font-size: 12px;">
          üìç ${report.distance} meters away
        </div>
      </div>
    `;
  });
  
  const warningHTML = `
    <div id="duplicateWarningModal" style="
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      backdrop-filter: blur(4px);
    ">
      <div style="
        background: white;
        border-radius: 16px;
        max-width: 500px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        animation: slideIn 0.3s ease-out;
      ">
        <div style="
          background: linear-gradient(135deg, #dc2626 0%, #f97316 100%);
          padding: 24px;
          border-radius: 16px 16px 0 0;
          text-align: center;
        ">
          <div style="font-size: 48px; margin-bottom: 8px;">‚ö†Ô∏è</div>
          <h2 style="margin: 0; color: white; font-size: 24px; font-weight: 800;">Duplicate Report Detected</h2>
        </div>
        
        <div style="padding: 24px;">
          <p style="color: #475569; font-size: 15px; line-height: 1.6; margin: 0 0 16px 0;">
            <strong>Waterlogging has already been reported in this area.</strong> To avoid duplicate reports, please check existing reports within a 100-meter radius:
          </p>
          
          <div style="margin: 20px 0;">
            ${reportsHTML}
          </div>
          
          <div style="background: #fef3c7; border: 1px solid #fbbf24; padding: 12px; border-radius: 8px; margin: 16px 0;">
            <p style="margin: 0; color: #92400e; font-size: 13px; line-height: 1.5;">
              <strong>üí° Tip:</strong> Check the map for existing markers before submitting a new report. This helps us maintain accurate data.
            </p>
          </div>
          
          <div style="display: flex; gap: 12px; margin-top: 20px;">
            <button onclick="closeDuplicateWarning()" style="
              flex: 1;
              padding: 14px;
              background: #1e293b;
              color: white;
              border: none;
              border-radius: 8px;
              font-size: 15px;
              font-weight: 700;
              cursor: pointer;
              transition: all 0.2s;
            " onmouseover="this.style.background='#334155'" onmouseout="this.style.background='#1e293b'">
              Got It
            </button>
            <button onclick="viewNearbyReports()" style="
              flex: 1;
              padding: 14px;
              background: white;
              color: #1e293b;
              border: 2px solid #1e293b;
              border-radius: 8px;
              font-size: 15px;
              font-weight: 700;
              cursor: pointer;
              transition: all 0.2s;
            " onmouseover="this.style.background='#f1f5f9'" onmouseout="this.style.background='white'">
              View on Map
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <style>
      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(-20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  `;
  
  const existingModal = document.getElementById('duplicateWarningModal');
  if (existingModal) {
    existingModal.remove();
  }
  
  document.body.insertAdjacentHTML('beforeend', warningHTML);
}

function closeDuplicateWarning() {
  const modal = document.getElementById('duplicateWarningModal');
  if (modal) {
    modal.style.animation = 'slideOut 0.2s ease-in';
    setTimeout(() => modal.remove(), 200);
  }
}

function enableReportMode() {
  map.getContainer().style.cursor = 'crosshair';

  map.once('click', async function (e) {
    map.getContainer().style.cursor = '';

    const lat = e.latlng.lat;
    const lng = e.latlng.lng;

    // 1Ô∏è‚É£ Check duplicates
    const check = hasNearbyReport(lat, lng, 100);
    if (check.found) {
      showDuplicateWarning(check.reports);
      return;
    }

    try {
      // Use backend endpoint for consistent risk calculation
      const result = await fetchFloodRisk(lat, lng);

      const rainfall = result.rainfall_mm ?? result.rainfall ?? 0;
      const elevation = result.elevation ?? 0;
      const riskScore = result.floodRiskScore ?? result.floodRisk ?? calculateFloodRisk(rainfall, elevation);

      // Show result BEFORE report
      showFloodRiskModal(riskScore, rainfall, elevation);

      // Continue to report form
      openReportModal(lat, lng, false);
    } catch (err) {
      console.error("Flood risk error:", err);
      alert("Failed to calculate flood risk");
      openReportModal(lat, lng, false);
    }
  });
}
          color: white;
          border: none;
          border-radius: 8px;
          font-size: 15px;
          font-weight: 700;
          cursor: pointer;
        ">OK</button>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', successHTML);
}

function closeSuccessModal() {
  const modal = document.getElementById('successModal');
  if (modal) modal.remove();
}

function showWarningModal(title, message) {
  const warningHTML = `
    <div id="warningModal" style="
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
    ">
      <div style="
        background: white;
        border-radius: 12px;
        padding: 32px;
        text-align: center;
        max-width: 400px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      ">
        <div style="font-size: 56px; margin-bottom: 16px;">‚ö†Ô∏è</div>
        <h2 style="margin: 0 0 12px 0; color: #1e293b; font-size: 22px; font-weight: 800;">${title}</h2>
        <p style="margin: 0 0 24px 0; color: #64748b; font-size: 15px;">${message}</p>
        <button onclick="closeWarningModal()" style="
          padding: 12px 32px;
          background: #f97316;
          color: white;
          border: none;
          border-radius: 8px;
          font-size: 15px;
          font-weight: 700;
          cursor: pointer;
        ">OK</button>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', warningHTML);
}

function closeWarningModal() {
  const modal = document.getElementById('warningModal');
  if (modal) modal.remove();
}

function focusOnLocation(index) {
  closeModal();
  const f = priorityLocations[index];
  const [lng, lat] = f.geometry.coordinates;
  map.setView([lat, lng], 15);

  setTimeout(() => {
    L.circleMarker([lat, lng], {
      radius: 16,
      fillColor: "#dc2626",
      fillOpacity: 0.9,
      color: "#ffffff",
      weight: 3
    }).addTo(map)
      .bindPopup(
        `<div style="font-family: Inter, sans-serif; padding: 12px;">
          <h3 style="margin: 0 0 8px 0; color: #dc2626; font-size: 18px; font-weight: 800;">üö® CRITICAL ZONE</h3>
          <h4 style="margin: 0 0 4px 0; color: #1e293b; font-size: 16px; font-weight: 700;">${f.properties.Location_Road}</h4>
          <p style="margin: 0; color: #64748b; font-size: 14px; font-weight: 600;">Requires Immediate Attention</p>
        </div>`
      )
      .openPopup();
  }, 300);
}

/* MODAL CONTROLS */
function openModal() {
  document.getElementById("modal").style.display = "block";
}

function closeModal(e) {
  if (e && e.target.id !== "modal") return;
  document.getElementById("modal").style.display = "none";
}



// Custom popup styling
const style = document.createElement('style');
style.textContent = `
  .leaflet-popup-content-wrapper {
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.8);
  }
  .leaflet-popup-tip {
    display: none;
  }
  
  @keyframes slideOut {
    from {
      opacity: 1;
      transform: translateY(0);
    }
    to {
      opacity: 0;
      transform: translateY(-20px);
    }
  }
`;
setInterval(() => {
  reportMarkers = reportMarkers.filter(r => {
    if (minutesSince(r.createdAt) >= REPORT_EXPIRY_MINUTES) {
      const el = r.marker.getElement();
      if (el && !el.classList.contains('fade-out')) {
        el.classList.add('fade-out');
        setTimeout(() => map.removeLayer(r.marker), 2000);
      }
      return false;
    }
    return true;
  });
}, 60 * 1000);

document.head.appendChild(style);

// =====================
// LOAD REPORTS FROM DB
// =====================
async function loadReportsFromDB() {
  try {
    serverReports = []; // ‚úÖ reset

    const res = await fetch(`${API_BASE_URL}/api/reports`);
    if (!res.ok) {
      throw new Error("Failed to fetch reports");
    }

    const reports = await res.json();
    serverReports = reports; // ‚úÖ store globally

    reports.forEach(report => {
      const severityMap = {
        LOW: "#fde68a",
        MEDIUM: "#f97316",
        HIGH: "#dc2626"
      };

      L.circleMarker([report.latitude, report.longitude], {
        radius: 10,
        fillColor: severityMap[report.severity],
        fillOpacity: 0.9,
        color: "#ffffff",
        weight: 2
      })
      .addTo(map)
      .bindPopup(`
        <strong>${report.location}</strong><br/>
        Severity: ${report.severity}<br/>
        Rain: ${report.rainIntensity}
      `);
    });

    recomputeAllStats(); // ‚úÖ SINGLE SOURCE OF TRUTH
    updateHeatmap();
    startRainAnimation();


  } catch (err) {
    console.error("Failed to load reports from DB", err);
  }
}

// ‚úÖ CALL AFTER MAP LOAD
loadReportsFromDB();

</script>
</body>
</html>
