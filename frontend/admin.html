<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Admin Dashboard - Waterlogging Reports</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Inter', sans-serif;
  min-height: 100vh;
  background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
  display: flex;
  flex-direction: column;
}

/* HEADER */
.header {
  background: rgba(15, 23, 42, 0.95);
  backdrop-filter: blur(20px);
  color: white;
  padding: 20px 32px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
  border-bottom: 1px solid rgba(59, 130, 246, 0.2);
  position: sticky;
  top: 0;
  z-index: 100;
}

.header-content {
  max-width: 1400px;
  margin: 0 auto;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.header-left {
  display: flex;
  align-items: center;
  gap: 16px;
}

.admin-icon {
  font-size: 32px;
  animation: pulse 2s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.1); }
}

.header-title h1 {
  font-size: 24px;
  font-weight: 800;
  background: linear-gradient(135deg, #ffffff, #60a5fa);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.header-subtitle {
  font-size: 13px;
  color: #94a3b8;
  font-weight: 500;
  margin-top: 2px;
}

.header-actions {
  display: flex;
  gap: 12px;
}

.recalc-btn {
  background: linear-gradient(135deg, #f59e0b, #d97706);
  border: none;
  color: white;
  padding: 10px 20px;
  border-radius: 10px;
  font-weight: 700;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.3s ease;
  box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
}

.recalc-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(245, 158, 11, 0.5);
}

.clear-btn {
  background: linear-gradient(135deg, #dc2626, #b91c1c);
  border: none;
  color: white;
  padding: 10px 20px;
  border-radius: 10px;
  font-weight: 700;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.3s ease;
  box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
}

.clear-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(220, 38, 38, 0.5);
}

.logout-btn {
  background: linear-gradient(135deg, #dc2626, #ef4444);
  border: none;
  color: white;
  padding: 10px 20px;
  border-radius: 10px;
  font-weight: 700;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.3s ease;
  box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
}

.logout-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(220, 38, 38, 0.5);
}

/* MAIN CONTAINER */
.container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 32px;
  flex: 1;
}

/* STATS CARDS */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 20px;
  margin-bottom: 32px;
}

.stat-card {
  background: rgba(255, 255, 255, 0.05);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.1);
  padding: 24px;
  border-radius: 16px;
  transition: all 0.3s ease;
}

.stat-card:hover {
  background: rgba(255, 255, 255, 0.08);
  border-color: rgba(59, 130, 246, 0.4);
  transform: translateY(-4px);
  box-shadow: 0 8px 24px rgba(59, 130, 246, 0.2);
}

.stat-icon {
  font-size: 32px;
  margin-bottom: 12px;
}

.stat-label {
  font-size: 13px;
  color: #94a3b8;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 8px;
}

.stat-value {
  font-size: 36px;
  font-weight: 900;
  color: white;
}

.stat-pending { color: #f59e0b; }
.stat-approved { color: #10b981; }
.stat-rejected { color: #ef4444; }
.stat-total { color: #60a5fa; }

/* CONTROLS */
.controls-section {
  background: rgba(255, 255, 255, 0.05);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.1);
  padding: 24px;
  border-radius: 16px;
  margin-bottom: 24px;
}

.controls-row {
  display: flex;
  gap: 16px;
  align-items: center;
  flex-wrap: wrap;
}

.search-box {
  flex: 1;
  min-width: 300px;
  position: relative;
}

.search-icon {
  position: absolute;
  left: 16px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 18px;
  color: #64748b;
}

.search-input {
  width: 100%;
  padding: 14px 16px 14px 48px;
  border-radius: 12px;
  border: 2px solid rgba(255, 255, 255, 0.1);
  background: rgba(255, 255, 255, 0.05);
  color: white;
  font-size: 15px;
  font-weight: 500;
  transition: all 0.3s ease;
}

.search-input::placeholder {
  color: #64748b;
}

.search-input:focus {
  outline: none;
  border-color: #3b82f6;
  background: rgba(255, 255, 255, 0.08);
  box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
}

.filter-group {
  display: flex;
  gap: 12px;
  align-items: center;
}

.filter-label {
  color: #cbd5e1;
  font-weight: 600;
  font-size: 14px;
}

.filter-select {
  padding: 12px 16px;
  border-radius: 10px;
  border: 2px solid rgba(255, 255, 255, 0.1);
  background: rgba(255, 255, 255, 0.05);
  color: white;
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.3s ease;
  min-width: 150px;
}

.filter-select:focus {
  outline: none;
  border-color: #3b82f6;
  box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
}

.filter-select option {
  background: #1e293b;
  color: white;
}

/* REPORTS TABLE */
.reports-section {
  background: rgba(255, 255, 255, 0.05);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 16px;
  overflow: hidden;
}

.section-header {
  padding: 24px 28px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.section-title {
  font-size: 20px;
  font-weight: 800;
  color: white;
}

.bulk-actions {
  display: flex;
  gap: 12px;
}

.bulk-btn {
  padding: 10px 18px;
  border-radius: 10px;
  border: none;
  font-weight: 700;
  font-size: 13px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.approve-all {
  background: linear-gradient(135deg, #10b981, #059669);
  color: white;
  box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
}

.approve-all:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
}

.reject-all {
  background: linear-gradient(135deg, #ef4444, #dc2626);
  color: white;
  box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
}

.reject-all:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(239, 68, 68, 0.4);
}
.no-results {
  height: 300px;              /* üëà ADD */
  display: flex;              /* üëà ADD */
  flex-direction: column;     /* üëà ADD */
  align-items: center;        /* üëà ADD */
  justify-content: center;    /* üëà ADD */
  text-align: center;
  color: #64748b;
}

.table-container {
  overflow-x: auto;
  max-height: 600px;
  min-height: 400px; /* üëà ADD THIS */
  overflow-y: auto;
  transition: all 0.2s ease;
}

.reports-table {
  width: 100%;
  border-collapse: collapse;
}

.reports-table thead {
  background: rgba(15, 23, 42, 0.5);
  position: sticky;
  top: 0;
  z-index: 10;
}

.reports-table th {
  padding: 16px 20px;
  text-align: left;
  font-size: 12px;
  font-weight: 700;
  color: #94a3b8;
  text-transform: uppercase;
  letter-spacing: 1px;
  border-bottom: 2px solid rgba(59, 130, 246, 0.3);
}

.reports-table td {
  padding: 20px;
  color: #e2e8f0;
  font-size: 14px;
  font-weight: 500;
  border-bottom: 1px solid rgba(255, 255, 255, 0.05);
}

.reports-table tbody tr {
  transition: all 0.2s ease;
  cursor: pointer;
}

.reports-table tbody tr:hover {
  background: rgba(59, 130, 246, 0.08);
}

.reports-table tbody tr.selected {
  background: rgba(59, 130, 246, 0.15);
  border-left: 4px solid #3b82f6;
}

.checkbox-cell {
  width: 50px;
}

.custom-checkbox {
  width: 20px;
  height: 20px;
  cursor: pointer;
  accent-color: #3b82f6;
}

.report-id {
  font-weight: 700;
  color: #60a5fa;
}

.location-text {
  max-width: 300px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.severity-badge {
  display: inline-block;
  padding: 6px 14px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.severity-low {
  background: rgba(253, 230, 138, 0.2);
  color: #fbbf24;
  border: 1px solid rgba(251, 191, 36, 0.3);
}

.severity-medium {
  background: rgba(249, 115, 22, 0.2);
  color: #fb923c;
  border: 1px solid rgba(249, 115, 22, 0.3);
}

.severity-high {
  background: rgba(239, 68, 68, 0.2);
  color: #f87171;
  border: 1px solid rgba(239, 68, 68, 0.3);
}

.status-badge {
  display: inline-block;
  padding: 6px 14px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 700;
  text-transform: uppercase;
}

.status-pending {
  background: rgba(245, 158, 11, 0.2);
  color: #fbbf24;
  border: 1px solid rgba(245, 158, 11, 0.3);
}

.status-approved {
  background: rgba(16, 185, 129, 0.2);
  color: #34d399;
  border: 1px solid rgba(16, 185, 129, 0.3);
}

.status-rejected {
  background: rgba(239, 68, 68, 0.2);
  color: #f87171;
  border: 1px solid rgba(239, 68, 68, 0.3);
}

.timestamp {
  color: #94a3b8;
  font-size: 13px;
}

.action-buttons {
  display: flex;
  gap: 8px;
}

.action-btn {
  padding: 8px 14px;
  border-radius: 8px;
  border: none;
  font-weight: 700;
  font-size: 12px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.approve-btn {
  background: #10b981;
  color: white;
}

.approve-btn:hover {
  background: #059669;
  transform: scale(1.05);
}

.reject-btn {
  background: #ef4444;
  color: white;
}

.reject-btn:hover {
  background: #dc2626;
  transform: scale(1.05);
}

.view-btn {
  background: #3b82f6;
  color: white;
}

.view-btn:hover {
  background: #2563eb;
  transform: scale(1.05);
}

.map-btn {
  background: #8b5cf6;
  color: white;
}

.map-btn:hover {
  background: #7c3aed;
  transform: scale(1.05);
}

/* NO RESULTS */
.no-results {
  padding: 60px 20px;
  text-align: center;
  color: #64748b;
}

.no-results-icon {
  font-size: 64px;
  margin-bottom: 16px;
}

.no-results-text {
  font-size: 18px;
  font-weight: 600;
}

/* SCROLLBAR */
.table-container::-webkit-scrollbar {
  width: 10px;
  height: 10px;
}

.table-container::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
}

.table-container::-webkit-scrollbar-thumb {
  background: rgba(59, 130, 246, 0.3);
  border-radius: 10px;
}

.table-container::-webkit-scrollbar-thumb:hover {
  background: rgba(59, 130, 246, 0.5);
}

/* RESPONSIVE */
@media (max-width: 1024px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .controls-row {
    flex-direction: column;
    align-items: stretch;
  }
  
  .search-box {
    width: 100%;
  }
}

/* MAP MODAL */
#mapModal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(15, 23, 42, 0.85);
  backdrop-filter: blur(12px);
  z-index: 3000;
  animation: fadeIn 0.3s ease;
}

#mapModalContent {
  background: linear-gradient(135deg, #ffffff, #f8fafc);
  width: 90%;
  max-width: 1200px;
  height: 85vh;
  margin: 5vh auto;
  border-radius: 20px;
  box-shadow: 0 25px 80px rgba(0, 0, 0, 0.4);
  animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  border: 1px solid rgba(255, 255, 255, 0.8);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(50px) scale(0.95);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

.map-modal-header {
  padding: 20px 28px;
  background: linear-gradient(135deg, #3b82f6, #2563eb);
  color: white;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-radius: 20px 20px 0 0;
}

.map-modal-header h3 {
  font-size: 20px;
  font-weight: 800;
  margin: 0;
  display: flex;
  align-items: center;
  gap: 10px;
}

.map-close-btn {
  background: rgba(255, 255, 255, 0.2);
  border: none;
  color: white;
  width: 36px;
  height: 36px;
  border-radius: 50%;
  font-size: 20px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
}
.reports-table {
  width: 100%;
  min-width: 100%;
  table-layout: fixed; /* üëà VERY IMPORTANT */
}
.reports-section {
  width: 100%;
  min-width: 100%;
}

.map-close-btn:hover {
  background: rgba(255, 255, 255, 0.3);
  transform: rotate(90deg);
}

#previewMap {
  flex: 1;
  width: 100%;
}

/* IMAGE MODAL */
#imageModal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.9);
  backdrop-filter: blur(8px);
  z-index: 4000;
  animation: fadeIn 0.3s ease;
  display: none;
  justify-content: center;
  align-items: center;
  padding: 20px;
}

#imageModal.show {
  display: flex;
}

.image-modal-content {
  max-width: 90%;
  max-height: 90vh;
  position: relative;
  animation: zoomIn 0.3s ease;
}

@keyframes zoomIn {
  from {
    opacity: 0;
    transform: scale(0.8);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

.modal-image {
  max-width: 100%;
  max-height: 85vh;
  border-radius: 12px;
  box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5);
  object-fit: contain;
}

.image-close-btn {
  position: absolute;
  top: -15px;
  right: -15px;
  background: #dc2626;
  border: none;
  color: white;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  font-size: 24px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
  box-shadow: 0 4px 12px rgba(220, 38, 38, 0.4);
}

.image-close-btn:hover {
  background: #b91c1c;
  transform: rotate(90deg) scale(1.1);
}

.image-info {
  position: absolute;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(15, 23, 42, 0.95);
  backdrop-filter: blur(10px);
  padding: 12px 24px;
  border-radius: 12px;
  color: white;
  font-size: 14px;
  font-weight: 600;
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
}
.pending-only-btn {
  background: linear-gradient(135deg, #f59e0b, #d97706);
  color: white;
  border: none;
  padding: 12px 16px;
  border-radius: 10px;
  font-weight: 700;
  cursor: pointer;
  font-size: 13px;
  box-shadow: 0 4px 12px rgba(245, 158, 11, 0.35);
  transition: all 0.2s ease;
}

.pending-only-btn.active {
  background: linear-gradient(135deg, #16a34a, #15803d);
}

.pending-only-btn:hover {
  transform: translateY(-2px);
}

.proof-thumb {
  width: 42px;
  height: 42px;
  object-fit: cover;
  border-radius: 8px;
  cursor: pointer;
  border: 2px solid rgba(59,130,246,0.4);
  transition: transform 0.2s ease;
}

.proof-thumb:hover {
  transform: scale(1.15);
}

.no-proof {
  color: #94a3b8;
  font-size: 13px;
}

/* IMAGE MODAL */
.image-modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(15,23,42,0.85);
  backdrop-filter: blur(10px);
  z-index: 5000;
  align-items: center;
  justify-content: center;
}

.image-modal-content {
  max-width: 80%;
  max-height: 80%;
}

.image-modal-content img {
  max-width: 100%;
  max-height: 100%;
  border-radius: 16px;
  box-shadow: 0 25px 80px rgba(0,0,0,0.6);
}
.view-report-content {
  background: #0f172a;
  padding: 24px;
  border-radius: 16px;
  max-width: 520px;
  width: 90%;
  color: white;
  box-shadow: 0 25px 80px rgba(0,0,0,0.6);
}

.view-row {
  margin-bottom: 12px;
  font-size: 14px;
}

#viewImageContainer img {
  margin-top: 10px;
  max-width: 100%;
  border-radius: 12px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.4);
}

.no-proof {
  color: #94a3b8;
  font-size: 13px;
}
.view-report-content {
  background: #0f172a;
  color: white;
  padding: 24px;
  border-radius: 16px;
  max-width: 520px;
  width: 90%;
}

#viewImageContainer img {
  margin-top: 12px;
  max-width: 100%;
  border-radius: 12px;
}


</style>
</head>

<body>

<!-- HEADER -->
<header class="header">
  <div class="header-content">
    <div class="header-left">
      <div class="admin-icon">üîê</div>
      <div class="header-title">
        <h1>Admin Dashboard</h1>
        <div class="header-subtitle">Waterlogging Report Management</div>
      </div>
    </div>
    <div class="header-actions">
      <button class="recalc-btn" onclick="recalculateTrustScores()">üîÑ Recalc Trust</button>
      <button class="clear-btn" onclick="clearAllReports()">üóëÔ∏è Clear All</button>
      <button class="logout-btn" onclick="logout()">üö™ Logout</button>
    </div>
  </div>
</header>

<!-- MAIN CONTAINER -->
<div class="container">
  
  <!-- STATS CARDS -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-icon">‚è≥</div>
      <div class="stat-label">Pending</div>
      <div class="stat-value stat-pending" id="pendingCount">0</div>
    </div>
    
    <div class="stat-card">
      <div class="stat-icon">‚úÖ</div>
      <div class="stat-label">Approved</div>
      <div class="stat-value stat-approved" id="approvedCount">0</div>
    </div>
    
    <div class="stat-card">
      <div class="stat-icon">‚ùå</div>
      <div class="stat-label">Rejected</div>
      <div class="stat-value stat-rejected" id="rejectedCount">0</div>
    </div>
    
    <div class="stat-card">
      <div class="stat-icon">üìä</div>
      <div class="stat-label">Total Reports</div>
      <div class="stat-value stat-total" id="totalCount">0</div>
    </div>
  </div>
  
  <!-- CONTROLS -->
  <div class="controls-section">
    <div class="controls-row">
      <div class="search-box">
        <span class="search-icon">üîç</span>
        <input 
          type="text" 
          class="search-input" 
          id="searchInput"
          placeholder="Search by location, ID, or coordinates..."
          oninput="filterReports()"
        />
      </div>
      
      <div class="filter-group">
        <span class="filter-label">Status:</span>
        <select class="filter-select" id="statusFilter" onchange="filterReports()">
          <option value="all">All Reports</option>
          <option value="pending">Pending</option>
          <option value="approved">Approved</option>
          <option value="rejected">Rejected</option>
        </select>
      </div>
      
      <div class="filter-group">
        <span class="filter-label">Severity:</span>
        <select class="filter-select" id="severityFilter" onchange="filterReports()">
          <option value="all">All Levels</option>
          <option value="high">High</option>
          <option value="medium">Medium</option>
          <option value="low">Low</option>
        </select>
      </div>
      <button class="pending-only-btn" onclick="togglePendingOnly()">
    ‚è≥ Pending Only
  </button>
    </div>
  </div>
  
  <!-- REPORTS TABLE -->
  <div class="reports-section">
    <div class="section-header">
      <div class="section-title">üìã Reported Locations</div>
      <div class="bulk-actions">
        <button class="bulk-btn approve-all" onclick="approveSelected()">
          ‚úÖ Approve Selected
        </button>
        <button class="bulk-btn reject-all" onclick="rejectSelected()">
          ‚ùå Reject Selected
        </button>
        <button class="bulk-btn" onclick="removeSelected()" style="background:linear-gradient(135deg,#94a3b8,#64748b);color:white">
          üóëÔ∏è Remove Selected
        </button>
      </div>
    </div>
    
    <div class="table-container">
      <table class="reports-table">
        <thead>
          <tr>
            <th class="checkbox-cell">
              <input type="checkbox" class="custom-checkbox" id="selectAll" onchange="toggleSelectAll()">
            </th>
            <th>Report ID</th>
            <th>User Trust</th>
            <th>Location</th>
            <th>Coordinates</th>
            <th>Severity</th>
            <th>Status</th>
            <th>Reported At</th>
            <th>Proof</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="reportsTableBody">
          <!-- Reports will be populated here -->
        </tbody>
      </table>
      
      <div id="noResults" class="no-results" style="display: none;">
        <div class="no-results-icon">üîç</div>
        <div class="no-results-text">No reports found</div>
      </div>
    </div>
  </div>
  
</div>

<!-- MAP MODAL -->
<div id="mapModal" onclick="closeMapModal(event)">
  <div id="mapModalContent" onclick="event.stopPropagation()">
    <div class="map-modal-header">
      <h3>üó∫Ô∏è Location Preview</h3>
      <button class="map-close-btn" onclick="closeMapModal()">‚úï</button>
    </div>
    <div id="previewMap"></div>
  </div>
</div>

<!-- IMAGE MODAL -->
<div id="imageModal" onclick="closeImageModal()">
  <div class="image-modal-content" onclick="event.stopPropagation()">
    <button class="image-close-btn" onclick="closeImageModal()">‚úï</button>
    <img id="modalImage" class="modal-image" src="" alt="Report Photo">
    <div class="image-info" id="imageInfo">Photo Proof</div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
const API_BASE_URL = "https://water-logging.onrender.com";

// Reports array - loaded from backend API
let reports = [];
let filteredReports = [];
let allReportsFromDB = [];

// Fetch reports from backend API on page load
async function loadReportsFromAPI() {
  try {
    const token = localStorage.getItem('token');
    
    if (!token) {
      console.error('‚ùå NO TOKEN FOUND - Admin not logged in');
      alert('‚ö†Ô∏è No authentication token. Please log in as admin first.');
      window.location.href = 'index.html';
      return;
    }
    
    console.log('‚úÖ Admin auth token found - fetching reports...');
    
    const res = await fetch(`${API_BASE_URL}/api/reports/admin`, {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    if (!res.ok) {
      console.error(`‚ùå API Error: ${res.status} - ${res.statusText}`);
      throw new Error(`HTTP ${res.status}: ${res.statusText}`);
    }
    
    const data = await res.json();
    console.log('‚úÖ Reports fetched from API:', data);
    
    // Map backend report format to UI format
    allReportsFromDB = data.map(report => ({
      id: String(report.id),
      location: report.location || 'Unknown',
      lat: report.latitude || 0,
      lng: report.longitude || 0,
      severity: (report.severity || 'MEDIUM').toLowerCase(),
      status: report.is_approved ? 'approved' : 'pending',
      image: report.image || null,
      timestamp: report.createdAt ? new Date(report.createdAt).toLocaleString() : '‚Äî',
      userId: report.user_id,
      // ensure trust score is always a Number (default 0) so UI shows 0% instead of '‚Äî'
      userTrustScore: report.user && report.user.trust_score != null ? Number(report.user.trust_score) : 0,
      rainIntensity: report.rainIntensity
    }));
    
    reports = [...allReportsFromDB];
    filteredReports = [...reports];
    
    console.log(`‚úÖ Loaded ${reports.length} reports from database`);
    updateStats();
    renderReports();
  } catch (err) {
    console.error('‚ùå Failed to load reports:', err);
    alert(`‚ùå Error loading reports: ${err.message}`);
  }
}

// Load on page load
window.addEventListener('load', loadReportsFromAPI);

let selectedReports = new Set();

let previewMap = null;

function updateStats() {
  const pending = reports.filter(r => r.status === 'pending').length;
  const approved = reports.filter(r => r.status === 'approved').length;
  const rejected = reports.filter(r => r.status === 'rejected').length;
  
  document.getElementById('pendingCount').textContent = pending;
  document.getElementById('approvedCount').textContent = approved;
  document.getElementById('rejectedCount').textContent = rejected;
  document.getElementById('totalCount').textContent = reports.length;
}

function renderReports() {
  const tbody = document.getElementById('reportsTableBody');
  const noResults = document.getElementById('noResults');

  if (!filteredReports.length) {
    tbody.innerHTML = '';
    noResults.style.display = 'block';
    return;
  }

  noResults.style.display = 'none';

  tbody.innerHTML = filteredReports.map(report => {
    const locationText = report.location || report.locationName || '‚Äî';

    const coordsText =
      typeof report.lat === 'number' && typeof report.lng === 'number'
        ? `${report.lat.toFixed(4)}, ${report.lng.toFixed(4)}`
        : '‚Äî';

    return `
      <tr onclick="toggleRowSelection('${report.id}', event)">
        <td class="checkbox-cell">
          <input type="checkbox"
                 class="custom-checkbox"
                 ${selectedReports.has(report.id) ? 'checked' : ''}
                 onclick="event.stopPropagation()"
                 onchange="toggleReportSelection('${report.id}')">
        </td>

        <td class="report-id">${report.id}</td>

        <td>
          <span class="stat-value">
            ${!isNaN(report.userTrustScore) ? `${Math.round(report.userTrustScore)}%` : '‚Äî'}
          </span>
        </td>

        <td class="location-text">${locationText}</td>

        <td>${coordsText}</td>

        <td>
          <span class="severity-badge severity-${report.severity}">
            ${report.severity}
          </span>
        </td>

        <td>
          <span class="status-badge status-${report.status}">
            ${report.status}
          </span>
        </td>

        <td class="timestamp">${report.timestamp || '‚Äî'}</td>

        <td>
  ${report.image ? `
    <img 
      src="${report.image}"
      class="proof-thumb"
      onclick="viewImage('${report.id}', event)"
      title="Click to view image"
    />
  ` : '<span class="no-proof">‚Äî</span>'}
</td>


        <td>
          <div class="action-buttons">
            ${report.status === 'pending' ? `
              <button class="action-btn approve-btn"
                      onclick="approveReport('${report.id}', event)">‚úì</button>
              <button class="action-btn reject-btn"
                      onclick="rejectReport('${report.id}', event)">‚úó</button>
            ` : ''}
            <button class="action-btn map-btn"
                    onclick="showMapPreview('${report.id}', event)">üìç</button>
            <button class="action-btn view-btn"
                    onclick="viewReport('${report.id}', event)">üëÅ</button>
          </div>
        </td>
      </tr>
    `;
  }).join('');
}

let pendingOnly = false;

function togglePendingOnly() {
  pendingOnly = !pendingOnly;

  const btn = document.querySelector('.pending-only-btn');
  btn.classList.toggle('active', pendingOnly);

  if (pendingOnly) {
    filteredReports = reports.filter(r => r.status === 'pending');
  } else {
    filteredReports = [...reports];
  }

  renderReports();
}


function filterReports() {
  const searchTerm =
    document.getElementById('searchInput').value.toLowerCase();

  const statusFilter =
    document.getElementById('statusFilter').value;

  const severityFilter =
    document.getElementById('severityFilter').value;

  filteredReports = reports.filter(report => {

    const locationText =
      (report.location || report.locationName || '').toLowerCase();

    const coordsText =
      typeof report.lat === 'number' && typeof report.lng === 'number'
        ? `${report.lat.toFixed(4)}, ${report.lng.toFixed(4)}`
        : '';

    const matchesSearch =
      locationText.includes(searchTerm) ||
      report.id.toLowerCase().includes(searchTerm) ||
      coordsText.includes(searchTerm);

    const matchesStatus =
      statusFilter === 'all' || report.status === statusFilter;

    const matchesSeverity =
      severityFilter === 'all' || report.severity === severityFilter;

    return matchesSearch && matchesStatus && matchesSeverity;
  });

  /* ‚úÖ ADD THIS PART */
  const noResults = document.getElementById('noResults');
  const textEl = noResults.querySelector('.no-results-text');

  if (filteredReports.length === 0) {
    textEl.textContent =
      statusFilter === 'pending'
        ? 'No pending reports üéâ'
        : 'No reports found';
  }

  renderReports();
}

function toggleSelectAll() {
  const selectAll = document.getElementById('selectAll');
  
  if (selectAll.checked) {
    filteredReports.forEach(report => selectedReports.add(report.id));
  } else {
    selectedReports.clear();
  }
  
  renderReports();
}

function toggleReportSelection(reportId) {
  if (selectedReports.has(reportId)) {
    selectedReports.delete(reportId);
  } else {
    selectedReports.add(reportId);
  }
  
  document.getElementById('selectAll').checked = 
    selectedReports.size === filteredReports.length && filteredReports.length > 0;
  
  renderReports();
}

function toggleRowSelection(reportId, event) {
  if (event.target.tagName !== 'BUTTON' && event.target.type !== 'checkbox') {
    toggleReportSelection(reportId);
  }
}

async function approveReport(reportId, event) {
  if (event) event.stopPropagation();
  const report = reports.find(r => r.id === reportId);
  if (!report) return;
  
  try {
    const token = localStorage.getItem('token');
    const res = await fetch(`${API_BASE_URL}/api/reports/${reportId}/approve`, {
      method: 'PATCH',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    
    const result = await res.json();
    console.log(`‚úÖ Report ${reportId} approved on backend`);
    
    report.status = 'approved';
    updateStats();
    renderReports();
    showNotification(`‚úÖ Report ${reportId} approved successfully`, 'success');
  } catch (err) {
    console.error('‚ùå Approval failed:', err);
    showNotification(`‚ùå Approval failed: ${err.message}`, 'error');
  }
}

async function recalculateTrustScores() {
  try {
    const token = localStorage.getItem('token');
    const res = await fetch(`${API_BASE_URL}/api/reports/recalculate-trust`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    
    const result = await res.json();
    console.log('‚úÖ Trust scores recalculated:', result);
    showNotification(`‚úÖ ${result.message}`, 'success');
    
    // Reload reports to get updated trust scores
    await loadReportsFromAPI();
  } catch (err) {
    console.error('‚ùå Recalculation failed:', err);
    showNotification(`‚ùå Recalculation failed: ${err.message}`, 'error');
  }
}

async function clearAllReports() {
  const confirmed = confirm('‚ö†Ô∏è WARNING: This will permanently delete ALL reports and reset ALL user trust scores to 0%. This action cannot be undone. Are you sure?');

  if (!confirmed) return;

  try {
    const token = localStorage.getItem('token');
    const res = await fetch(`${API_BASE_URL}/api/reports/clear-all`, {
      method: 'DELETE',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });

    if (!res.ok) throw new Error(`HTTP ${res.status}`);

    const result = await res.json();
    console.log('‚úÖ All reports cleared:', result);
    showNotification(`‚úÖ ${result.message}`, 'success');

    // Reload reports (should be empty now)
    await loadReportsFromAPI();
  } catch (err) {
    console.error('‚ùå Clear failed:', err);
    showNotification(`‚ùå Clear failed: ${err.message}`, 'error');
  }
}

function addToGeoJSON(report) {
  // In a real application, this would make an API call to update the GeoJSON file
  // For demo purposes, we'll show that it's been approved
  console.log('Adding to GeoJSON:', {
    type: 'Feature',
    properties: {
      Location_Road: report.location || report.locationName || 'Unknown',
      Risk: report.severity.charAt(0).toUpperCase() + report.severity.slice(1)
    },
    geometry: {
      type: 'Point',
      coordinates: [report.lng, report.lat]
    }
  });
  
  // Store approved locations separately
  let approvedLocations = JSON.parse(localStorage.getItem('approvedLocations') || '[]');
  approvedLocations.push({
    id: report.id,
    location: report.location || report.locationName || 'Unknown',
    lat: report.lat,
    lng: report.lng,
    severity: report.severity,
    timestamp: report.timestamp
  });
  localStorage.setItem('approvedLocations', JSON.stringify(approvedLocations));
}

function rejectReport(reportId, event) {
  if (event) event.stopPropagation();
  const report = reports.find(r => r.id === reportId);
  if (report) {
    report.status = 'rejected';
    
    // Save to localStorage
    localStorage.setItem('waterloggingReports', JSON.stringify(reports));
    
    updateStats();
    renderReports();
    showNotification(`‚ùå Report ${reportId} rejected`, 'error');
  }
}

function viewReport(reportId, event) {
  if (event) event.stopPropagation();


  const report = reports.find(r => r.id === reportId);
  if (!report) return;

  document.getElementById('viewLocation').textContent =
  report.location || report.locationName || '‚Äî';

  document.getElementById('viewCoords').textContent =
    `${report.lat.toFixed(5)}, ${report.lng.toFixed(5)}`;
  document.getElementById('viewSeverity').textContent = report.severity || '‚Äî';
  document.getElementById('viewTime').textContent = report.timestamp || '‚Äî';

  const container = document.getElementById('viewImageContainer');
  container.innerHTML = '';

  if (report.image && report.image.startsWith('data:image')) {
    const img = document.createElement('img');
    img.src = report.image;
    container.appendChild(img);
  } else {
    container.innerHTML = '<span class="no-proof">No image uploaded</span>';
  }

  document.getElementById('viewReportModal').style.display = 'flex';
}

function closeViewReportModal() {
  document.getElementById('viewReportModal').style.display = 'none';
}


function viewImage(reportId, event) {
  event.stopPropagation();
  const report = reports.find(r => r.id === reportId);
  if (!report || !report.image) return;

  document.getElementById('modalImage').src = report.image;
  document.getElementById('imageModal').style.display = 'flex';
}


function showMapPreview(reportId, event) {
  if (event) event.stopPropagation();
  const report = reports.find(r => r.id === reportId);
  if (!report) return;
  
  const modal = document.getElementById('mapModal');
  modal.style.display = 'block';
  
  // Initialize map if not already done
  if (!previewMap) {
    previewMap = L.map('previewMap').setView([report.lat, report.lng], 15);
    
    L.tileLayer(
      "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",
      { 
        attribution: "¬© OpenStreetMap ¬© CARTO",
        maxZoom: 19
      }
    ).addTo(previewMap);
  } else {
    previewMap.setView([report.lat, report.lng], 15);
  }
  
  // Clear existing markers
  previewMap.eachLayer(layer => {
    if (layer instanceof L.CircleMarker) {
      previewMap.removeLayer(layer);
    }
  });
  
  // Add marker for the report
  const severityColors = {
    'low': '#fde68a',
    'medium': '#f97316',
    'high': '#dc2626'
  };
  
  const severityIcons = {
    'low': '‚ö†Ô∏è',
    'medium': 'üü†',
    'high': 'üî¥'
  };
  
  L.circleMarker([report.lat, report.lng], {
    radius: 12,
    fillColor: severityColors[report.severity] || '#f97316',
    fillOpacity: 0.8,
    color: "#ffffff",
    weight: 3
  }).addTo(previewMap)
    .bindPopup(
      `<div style="font-family: Inter, sans-serif; padding: 12px;">
        <h4 style="margin: 0 0 8px 0; color: #1e293b; font-size: 16px; font-weight: 700;">${severityIcons[report.severity]} ${report.location || report.locationName || '‚Äî'}</h4>
        <p style="margin: 0 0 4px 0; color: #64748b; font-size: 14px;"><b>ID:</b> ${report.id}</p>
        <p style="margin: 0 0 4px 0; color: #64748b; font-size: 14px;"><b>Severity:</b> ${report.severity.toUpperCase()}</p>
        <p style="margin: 0 0 4px 0; color: #64748b; font-size: 14px;"><b>Status:</b> ${report.status.toUpperCase()}</p>
        <p style="margin: 0; color: #94a3b8; font-size: 12px;">${report.timestamp}</p>
      </div>`
    )
    .openPopup();
  
  // Force map to refresh
  setTimeout(() => {
    previewMap.invalidateSize();
  }, 100);
}

function closeMapModal(e) {
  if (e && e.target.id !== 'mapModal') return;
  document.getElementById('mapModal').style.display = 'none';
}

function approveSelected() {
  if (selectedReports.size === 0) {
    showNotification('‚ö†Ô∏è Please select reports to approve', 'warning');
    return;
  }
  
  const count = selectedReports.size;
  
  selectedReports.forEach(reportId => {
    const report = reports.find(r => r.id === reportId);
    if (report && report.status === 'pending') {
      report.status = 'approved';
      addToGeoJSON(report);
    }
  });
  
  // Save to localStorage
  localStorage.setItem('waterloggingReports', JSON.stringify(reports));
  
  selectedReports.clear();
  updateStats();
  renderReports();
  showNotification(`‚úÖ ${count} report(s) approved successfully`, 'success');
}

function rejectSelected() {
  if (selectedReports.size === 0) {
    showNotification('‚ö†Ô∏è Please select reports to reject', 'warning');
    return;
  }
  
  const count = selectedReports.size;
  
  selectedReports.forEach(reportId => {
    const report = reports.find(r => r.id === reportId);
    if (report && report.status === 'pending') {
      report.status = 'rejected';
    }
  });
  
  // Save to localStorage
  localStorage.setItem('waterloggingReports', JSON.stringify(reports));
  
  selectedReports.clear();
  updateStats();
  renderReports();
  showNotification(`‚ùå ${count} report(s) rejected`, 'error');
}

function removeSelected() {
  if (selectedReports.size === 0) {
    showNotification('‚ö†Ô∏è Please select reports to remove', 'warning');
    return;
  }

  // NOTE: This action only removes reports from the admin UI (client-side view).
  // It does NOT delete anything from the server/database (Render).
  if (!confirm('Remove selected reports from view? This will NOT delete them from the server/database.')) return;

  const count = selectedReports.size;

  // Remove selected reports from the in-memory list
  selectedReports.forEach(reportId => {
    const idx = reports.findIndex(r => r.id === reportId);
    if (idx !== -1) reports.splice(idx, 1);
  });

  // Clear selection and refresh
  selectedReports.clear();
  filteredReports = [...reports];
  updateStats();
  renderReports();

  showNotification(`üóëÔ∏è ${count} report(s) removed from view`, 'info');
}

function showNotification(message, type) {
  alert(message);
}

function logout() {
  if (confirm('Are you sure you want to logout?')) {
    localStorage.removeItem('token');
    console.log('üö™ Admin logged out');
    window.location.href = 'index.html';
  }
}


function closeImageModal() {
  document.getElementById('imageModal').style.display = 'none';
}


function closeViewReportModal() {
  document.getElementById('viewReportModal').style.display = 'none';
}


// Initialize
updateStats();
renderReports();


</script>

<!-- VIEW REPORT MODAL -->
<div id="viewReportModal" class="image-modal" onclick="closeViewReportModal()">
  <div class="view-report-content" onclick="event.stopPropagation()">

    <h3 style="margin-bottom: 16px;">üìÑ Report Details</h3>

    <div class="view-row">
      <strong>Location:</strong>
      <span id="viewLocation">‚Äî</span>
    </div>

    <div class="view-row">
      <strong>Coordinates:</strong>
      <span id="viewCoords">‚Äî</span>
    </div>

    <div class="view-row">
      <strong>Severity:</strong>
      <span id="viewSeverity">‚Äî</span>
    </div>

    <div class="view-row">
      <strong>Reported At:</strong>
      <span id="viewTime">‚Äî</span>
    </div>

    <div class="view-row">
      <strong>Photo Proof:</strong>
      <div id="viewImageContainer">
        <span class="no-proof">No image uploaded</span>
      </div>
    </div>

  </div>
</div>




</body>

</html>

